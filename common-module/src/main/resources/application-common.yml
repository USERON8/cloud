# 閫氱敤閰嶇疆妯℃澘
# 鎵€鏈夊井鏈嶅姟閮藉彲浠ョ户鎵跨殑鍩虹閰嶇疆

server:
  shutdown: graceful
  tomcat:
    threads:
      max: ${SERVER_TOMCAT_THREADS_MAX:400}
      min-spare: ${SERVER_TOMCAT_THREADS_MIN_SPARE:20}
    max-connections: ${SERVER_TOMCAT_MAX_CONNECTIONS:20000}
    accept-count: ${SERVER_TOMCAT_ACCEPT_COUNT:1000}

spring:
  # 閫氱敤Spring閰嶇疆
  main:
    allow-bean-definition-overriding: true
  
  # Nacos閰嶇疆 - 鎵€鏈夋湇鍔＄粺涓€
  cloud:
    nacos:
      discovery:
        server-addr: ${NACOS_SERVER_ADDR:localhost:8848}
        username: ${NACOS_USERNAME:nacos}
        password: ${NACOS_PASSWORD:nacos}
        namespace: ${NACOS_NAMESPACE:public}
        group: ${NACOS_GROUP:DEFAULT_GROUP}
        prefer-ip-address: ${NACOS_PREFER_IP_ADDRESS:true}
        ip: ${NACOS_INSTANCE_IP:}
        port: ${NACOS_INSTANCE_PORT:${server.port}}
        ephemeral: ${NACOS_EPHEMERAL:true}
        metadata:
          instance-id: ${SERVICE_INSTANCE_ID:${spring.application.name}:${random.uuid}}
          deploy-mode: ${SERVICE_DEPLOY_MODE:multi}
          traffic-role: ${SERVICE_TRAFFIC_ROLE:business}
          singleton: ${SERVICE_SINGLETON:false}
      config:
        server-addr: ${NACOS_SERVER_ADDR:localhost:8848}
        username: ${NACOS_USERNAME:nacos}
        password: ${NACOS_PASSWORD:nacos}
        namespace: ${NACOS_NAMESPACE:public}
        file-extension: yaml
        group: ${NACOS_GROUP:DEFAULT_GROUP}
    
    # OpenFeign閫氱敤閰嶇疆
    openfeign:
      client:
        config:
          default:
            connectTimeout: ${FEIGN_CONNECT_TIMEOUT:5000}
            readTimeout: ${FEIGN_READ_TIMEOUT:10000}
            loggerLevel: ${FEIGN_LOG_LEVEL:basic}
      compression:
        request:
          enabled: true
        response:
          enabled: true
    
    # RocketMQ閫氱敤閰嶇疆
    stream:
      rocketmq:
        binder:
          name-server: ${ROCKETMQ_NAME_SERVER:127.0.0.1:39876}

  # 閰嶇疆瀵煎叆
  config:
    import: optional:nacos:common

  # 鏁版嵁搴撻€氱敤閰嶇疆
  datasource:
    driver-class-name: ${DB_DRIVER:com.mysql.cj.jdbc.Driver}
    username: ${DB_USERNAME:root}
    password: ${DB_PASSWORD:root}
    hikari:
      maximum-pool-size: ${DB_POOL_SIZE:20}
      minimum-idle: ${DB_MIN_IDLE:5}
      connection-timeout: ${DB_CONNECTION_TIMEOUT:30000}
      idle-timeout: ${DB_IDLE_TIMEOUT:600000}
      max-lifetime: ${DB_MAX_LIFETIME:1800000}

  # Redis閫氱敤閰嶇疆
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:root}
      timeout: ${REDIS_TIMEOUT:10000ms}
      lettuce:
        pool:
          max-active: ${REDIS_MAX_ACTIVE:50}      # 鏈€澶ц繛鎺ユ暟(浼樺寲鍚?
          max-wait: ${REDIS_MAX_WAIT:3000ms}      # 鏈€澶х瓑寰呮椂闂?閬垮厤鏃犻檺绛夊緟)
          max-idle: ${REDIS_MAX_IDLE:20}          # 鏈€澶х┖闂茶繛鎺?
          min-idle: ${REDIS_MIN_IDLE:5}           # 鏈€灏忕┖闂茶繛鎺?
          time-between-eviction-runs: 60000       # 绌洪棽杩炴帴妫€娴嬪懆鏈?姣)
        shutdown-timeout: ${REDIS_SHUTDOWN_TIMEOUT:100ms}

# 鏃ュ織閫氱敤閰嶇疆
logging:
  file:
    path: ${LOG_PATH:D:/logs}/${spring.application.name}
    name: ${logging.file.path}/${spring.application.name}.log
  level:
    com.cloud: ${LOG_LEVEL_CLOUD:info}
    org.springframework.security: ${LOG_LEVEL_SECURITY:warn}
    org.springframework.web: ${LOG_LEVEL_WEB:warn}
    org.springframework.cloud: ${LOG_LEVEL_CLOUD_FRAMEWORK:warn}

# MyBatis-Plus鍩虹閰嶇疆锛堝悇鏈嶅姟鍙互瑕嗙洊锛?
mybatis-plus:
  mapper-locations: classpath*:mapper/**/*.xml
  configuration:
    map-underscore-to-camel-case: true
    auto-mapping-behavior: full
    log-impl: ${MYBATIS_LOG_IMPL:org.apache.ibatis.logging.nop.NopImpl}
  global-config:
    enable-sql-runner: true
    db-config:
      id-type: assign_id
      logic-delete-field: deleted
      logic-not-delete-value: 0
      logic-delete-value: 1
      # 瀛楁绛栫暐閰嶇疆
      insert-strategy: not_null
      update-strategy: not_null
      select-strategy: not_empty

# SpringDoc OpenAPI閫氱敤閰嶇疆
springdoc:
  api-docs:
    enabled: ${API_DOCS_ENABLED:true}
    path: /v3/api-docs
  swagger-ui:
    enabled: ${SWAGGER_UI_ENABLED:true}
    path: /swagger-ui.html
    tags-sorter: alpha
    operations-sorter: alpha
  default-flat-param-object: true

# Knife4j閫氱敤閰嶇疆
knife4j:
  enable: ${KNIFE4J_ENABLED:true}
  production: ${KNIFE4J_PRODUCTION:false}
  basic:
    enable: false
  setting:
    language: ZH_CN
    enable-version: true
    enable-swagger-models: true
    swagger-model-name: 瀹炰綋绫诲垪琛?
    enable-footer-custom: true
    footer-custom-content: "Cloud 寰湇鍔″钩鍙?API 鏂囨。"

# 缂撳瓨閫氱敤閰嶇疆
cache:
  multi-level: ${CACHE_MULTI_LEVEL:true}  # 鍚敤澶氱骇缂撳瓨(Caffeine + Redis)
  consistency-enabled: ${CACHE_CONSISTENCY_ENABLED:false}  # 缂撳瓨涓€鑷存€ф満鍒?鏆傛椂鍏抽棴)
  ttl:
    user: ${CACHE_TTL_USER:1800}        # 鐢ㄦ埛鐩稿叧: 30鍒嗛挓
    product: ${CACHE_TTL_PRODUCT:2700}  # 鍟嗗搧鐩稿叧: 45鍒嗛挓
    stock: ${CACHE_TTL_STOCK:300}       # 搴撳瓨鐩稿叧: 5鍒嗛挓 (楂橀鍙樺寲)
    order: ${CACHE_TTL_ORDER:900}       # 璁㈠崟鐩稿叧: 15鍒嗛挓
    payment: ${CACHE_TTL_PAYMENT:600}   # 鏀粯鐩稿叧: 10鍒嗛挓
    search: ${CACHE_TTL_SEARCH:1200}    # 鎼滅储鐩稿叧: 20鍒嗛挓
    auth: ${CACHE_TTL_AUTH:3600}        # 鏉冮檺鐩稿叧: 1灏忔椂

# 鍒嗗竷寮忛攣閫氱敤閰嶇疆
cloud:
  distributed-lock:
    enabled: ${DISTRIBUTED_LOCK_ENABLED:true}
    default-wait-time: ${DISTRIBUTED_LOCK_WAIT_TIME:3}
    default-lease-time: ${DISTRIBUTED_LOCK_LEASE_TIME:10}
    key-prefix: ${DISTRIBUTED_LOCK_PREFIX:distributed-lock}
    monitor-enabled: ${DISTRIBUTED_LOCK_MONITOR:true}
    log-enabled: ${DISTRIBUTED_LOCK_LOG:true}

# 鏉冮檺閰嶇疆
app:
  deploy:
    # admin-service/log-service are singleton by default; others are multi-instance.
    singleton-services: ${APP_SINGLETON_SERVICES:admin-service,log-service}
  permission:
    enabled: ${PERMISSION_ENABLED:true}
    strict-mode: ${PERMISSION_STRICT_MODE:false}
  message:
    idempotent-enabled: ${MESSAGE_IDEMPOTENT_ENABLED:true}
    idempotent-expire-seconds: ${MESSAGE_IDEMPOTENT_EXPIRE_SECONDS:86400}

# 鐩戞帶閰嶇疆
management:
  endpoints:
    web:
      exposure:
        include: ${ACTUATOR_ENDPOINTS:health,info,metrics,prometheus}
  endpoint:
    health:
      show-details: ${HEALTH_SHOW_DETAILS:when_authorized}
  metrics:
    export:
      prometheus:
        enabled: ${PROMETHEUS_ENABLED:true}

