# Common Module 开发文档

## 项目版本信息

- **版本**: 0.0.1-SNAPSHOT
- **最后更新**: 2025-09-18
- **Java版本**: 17
- **Spring Boot版本**: 3.5.3

## 最近更新记录

### 2025-09-18 - 修复过时API使用问题

#### 修复的过时API问题

##### 1. SmartCacheManager.java 修复

- **问题1**: 使用了 `.toList()` 方法（Java 16+新增，可能不稳定）
    - **位置**: 第279行 `getHotCache()` 方法
    - **修复**: 改为 `.collect(Collectors.toList())`
    - **原因**: 提高兼容性和稳定性

- **问题2**: 使用了 `redisTemplate.keys()` 方法
    - **位置**: 第246行 `smartEvict()` 方法
    - **修复**: 使用 `scanKeys()` 方法替代，基于SCAN命令实现
    - **原因**: `keys()` 在生产环境会阻塞Redis，SCAN命令是非阻塞的

- **问题3**: 时间单位使用问题
    - **位置**: 第211行预热任务调度
    - **修复**: 改为使用 `interval.getSeconds(), TimeUnit.SECONDS`
    - **原因**: 提高精度和兼容性

### 2025-09-18 - 修复 RedisHashCacheService 编译问题

#### 问题描述

- **文件**: `com/cloud/common/cache/RedisHashCacheService.java`
- **行号**: 181
- **错误**: 最后一个参数使用了不准确的变量类型的 varargs 方法的非 varargs 调用

#### 问题分析

`hashOperations.delete(key, fields)` 方法调用中存在类型匹配问题：

- `hashOperations` 类型: `HashOperations<String, String, Object>`
- `delete` 方法签名: `Long delete(K key, Object... hashKeys)`
- 传入参数: `String... fields`
- 问题: `String[]` 无法直接匹配 `Object...` varargs 参数

#### 解决方案

将 `String[]` 显式转换为 `Object[]`：

```java
// 修复前
Long count = hashOperations.delete(key, fields);

// 修复后  
Long count = hashOperations.delete(key, (Object[]) fields);
```

#### 修复结果

- ✅ 编译成功
- ✅ 所有子服务编译通过
- ✅ 功能正常，类型安全

#### 依赖版本

- **Spring Data Redis**: Spring Boot 3.5.3 管理
- **Redis**: 7.0+
- **HikariCP**: 5.1.0

## 模块结构

```
common-module/
├── src/main/java/com/cloud/common/
│   ├── cache/                    # 缓存相关服务
│   │   ├── RedisHashCacheService.java  # Redis Hash 缓存服务 (已修复)
│   │   └── ...
│   ├── config/                   # 统一基础配置
│   ├── domain/                   # DTO/VO 统一管理  
│   ├── exception/                # 统一异常处理
│   └── utils/                    # 通用工具类
```

## 开发规范

1. **编译检查**: 每次代码修改后必须执行完整编译验证
2. **类型安全**: 注意 varargs 方法的类型匹配
3. **版本管理**: 严格按照开发文档中的版本来开发
4. **测试方式**: 主要通过 Postman 和 Knife4j 文档测试 API

## 编译命令

```bash
# 完整编译所有模块
mvn compile -f "D:/Download/Code/sofware/cloud/pom.xml"

# 仅编译 common-module
mvn compile -pl common-module
```

## 注意事项

- 本模块为所有业务服务的基础依赖
- 修改时需要考虑对所有依赖服务的影响
- 类型转换需要保证运行时安全性
- SQL 文件夹下的数据库表字段为准

---
**维护者**: what's up  
**文档创建**: 2025-09-18
