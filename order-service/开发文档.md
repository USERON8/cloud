# 订单服务开发文档

## 项目概述

订单服务负责处理订单的创建、支付、发货、完成、取消等生命周期管理，并通过RocketMQ消息队列与其他服务进行解耦通信。

## 技术栈

### 核心框架

- **Spring Boot**: 3.5.3
- **Spring Cloud**: 2025.0.0
- **Spring Cloud Alibaba**: 2025.0.0.0-preview
- **Spring Cloud Stream**: RocketMQ Binder
- **Java版本**: 17 LTS

### 依赖版本

```xml
<spring-boot.version>3.5.3</spring-boot.version>
<spring-cloud.version>2025.0.0</spring-cloud.version>
<spring-cloud-alibaba.version>2025.0.0.0-preview</spring-cloud-alibaba.version>
<java.version>17</java.version>
<mybatis-plus.version>3.5.13</mybatis-plus.version>
```

### 数据存储

- **MySQL**: 8.0+ (订单数据持久化)
- **MyBatis-Plus**: 3.5.13 (数据访问层)
- **RocketMQ**: 5.3.2 (消息队列，端口: 39876)
- **Redis**: 7.0+ (缓存)

## 订单事件消息系统

### 消息架构设计

#### 1. 事件驱动架构

基于阿里巴巴Spring Cloud Alibaba官方示例标准实现，采用事件驱动架构：

- **生产者**: 订单服务在业务操作时发送事件消息
- **消费者**: 日志服务消费事件消息并存储到Elasticsearch
- **消息中间件**: RocketMQ提供可靠消息传递

#### 2. 订单生命周期事件

| 事件类型                 | 事件标签                 | 触发时机   | 说明           |
|----------------------|----------------------|--------|--------------|
| ORDER_CREATED        | order-created        | 订单创建成功 | 新订单创建时触发     |
| ORDER_PAID           | order-paid           | 订单支付成功 | 支付完成时触发      |
| ORDER_SHIPPED        | order-shipped        | 订单发货   | 商品发货时触发      |
| ORDER_COMPLETED      | order-completed      | 订单完成   | 用户确认收货时触发    |
| ORDER_CANCELLED      | order-cancelled      | 订单取消   | 用户或系统取消订单时触发 |
| ORDER_REFUNDED       | order-refunded       | 订单退款   | 退款完成时触发      |
| ORDER_STATUS_CHANGED | order-status-changed | 订单状态变更 | 通用状态变更事件     |
| ORDER_TIMEOUT        | order-timeout        | 订单超时   | 支付超时等场景      |

### 核心组件

#### 1. 订单事件生产者 (OrderEventProducer)

```java
@Component
public class OrderEventProducer {
    private final StreamBridge streamBridge;
    private static final String ORDER_BINDING_NAME = "order-producer-out-0";
    
    // 发送订单创建事件
    public void sendOrderCreatedEvent(OrderChangeEvent event);
    // 发送订单支付事件
    public void sendOrderPaidEvent(OrderChangeEvent event);
    // 其他事件发送方法...
}
```

**特点**:

- 使用`StreamBridge`发送消息
- 统一的消息头构建（TraceId、Tag、Key等）
- 完整的异常处理和日志记录
- 消息发送成功确认机制

#### 2. 订单变更事件模型 (OrderChangeEvent)

```java
@Data
@Builder
public class OrderChangeEvent implements Serializable {
    private Long orderId;          // 订单ID
    private String orderNo;        // 订单编号
    private Long userId;           // 用户ID
    private Integer orderStatus;   // 订单状态
    private BigDecimal totalAmount; // 订单总金额
    // ... 其他订单相关字段
}
```

**字段说明**:

- 包含完整的订单信息和变更上下文
- 支持状态变更前后对比（oldOrderStatus）
- 包含时间戳、操作人等审计信息

#### 3. RocketMQ配置

**生产者配置** (application.yml):

```yaml
spring:
  cloud:
    stream:
      rocketmq:
        binder:
          name-server: 127.0.0.1:39876
      bindings:
        order-producer-out-0:
          destination: order-events
          content-type: application/json
          group: order-producer-group
          producer:
            maxRequestSize: 4194304
            sync: true
```

**消费者配置** (log-service):

```yaml
spring:
  cloud:
    stream:
      function:
        definition: orderConsumer
      bindings:
        orderConsumer-in-0:
          destination: order-events
          content-type: application/json
          group: log-service-order-group
      rocketmq:
        bindings:
          orderConsumer-in-0:
            consumer:
              subscription: 'order-created||order-paid||order-shipped||order-completed||order-cancelled||order-refunded||order-status-changed||order-timeout'
              messageModel: CLUSTERING
```

### 消息流程

#### 1. 消息发送流程

```
业务操作 -> OrderEventProducer -> RocketMQ Topic -> 日志服务消费者
```

1. **业务触发**: 订单状态变化时触发事件
2. **消息构建**: 构建事件对象和消息头
3. **消息发送**: 通过StreamBridge发送到RocketMQ
4. **发送确认**: 记录发送日志和结果

#### 2. 消息消费流程

```
RocketMQ消费 -> 事件处理器 -> 数据脱敏 -> Elasticsearch存储
```

1. **消息接收**: 函数式消费者接收消息
2. **幂等检查**: 基于TraceId防止重复处理
3. **数据脱敏**: 处理敏感信息（手机号、地址等）
4. **ES存储**: 保存到order-events索引

### 使用示例

#### 订单创建时发送事件

```java
@Service
public class OrderService {
    @Autowired
    private OrderEventProducer orderEventProducer;
    
    public void createOrder(CreateOrderRequest request) {
        // 1. 创建订单业务逻辑
        Order order = doCreateOrder(request);
        
        // 2. 构建事件对象
        OrderChangeEvent event = OrderChangeEvent.builder()
            .orderId(order.getId())
            .orderNo(order.getOrderNo())
            .userId(order.getUserId())
            .orderStatus(order.getStatus())
            .totalAmount(order.getTotalAmount())
            .eventTime(LocalDateTime.now())
            .build();
        
        // 3. 发送订单创建事件
        orderEventProducer.sendOrderCreatedEvent(event);
    }
}
```

#### 订单支付完成

```java
public void handlePaymentSuccess(Long orderId, PaymentInfo paymentInfo) {
    // 1. 更新订单状态
    Order order = updateOrderStatus(orderId, OrderStatus.PAID);
    
    // 2. 发送支付成功事件
    OrderChangeEvent event = OrderChangeEvent.builder()
        .orderId(order.getId())
        .oldOrderStatus(OrderStatus.PENDING.getValue())
        .orderStatus(OrderStatus.PAID.getValue())
        .paymentMethod(paymentInfo.getPaymentMethod())
        .paymentTime(paymentInfo.getPaymentTime())
        .build();
    
    orderEventProducer.sendOrderPaidEvent(event);
}
```

## 数据库设计

### 订单主表 (orders)

```sql
CREATE TABLE `orders` (
    id           BIGINT UNSIGNED PRIMARY KEY COMMENT '订单ID',
    user_id      BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
    total_amount DECIMAL(10, 2)  NOT NULL COMMENT '订单总额',
    pay_amount   DECIMAL(10, 2)  NOT NULL COMMENT '实付金额',
    status       TINYINT         NOT NULL COMMENT '状态：0-待支付，1-已支付，2-已发货，3-已完成，4-已取消',
    address_id   BIGINT UNSIGNED NOT NULL COMMENT '地址ID',
    created_at   DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at   DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted      TINYINT         NOT NULL DEFAULT 0 COMMENT '软删除标记'
);
```

### 订单明细表 (order_item)

```sql
CREATE TABLE `order_item` (
    id               BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    order_id         BIGINT UNSIGNED NOT NULL COMMENT '订单ID',
    product_id       BIGINT UNSIGNED NOT NULL COMMENT '商品ID',
    product_snapshot JSON            NOT NULL COMMENT '商品快照',
    quantity         INT             NOT NULL COMMENT '购买数量',
    price            DECIMAL(10, 2)  NOT NULL COMMENT '购买时单价',
    created_at       DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at       DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted          TINYINT         NOT NULL DEFAULT 0
);
```

## API设计

### 订单管理接口

- **POST** `/api/orders` - 创建订单
- **GET** `/api/orders/{orderId}` - 查询订单详情
- **PUT** `/api/orders/{orderId}/pay` - 订单支付
- **PUT** `/api/orders/{orderId}/ship` - 订单发货
- **PUT** `/api/orders/{orderId}/complete` - 订单完成
- **PUT** `/api/orders/{orderId}/cancel` - 取消订单

## 监控和运维

### 消息监控指标

- 消息发送成功率
- 消息发送延迟
- 消费者消费速度
- 消息积压情况

### 日志规范

- 使用结构化日志格式
- 包含TraceId用于链路追踪
- 记录关键业务操作和异常

### 异常处理

- 消息发送失败重试机制
- 死信队列处理
- 业务异常和系统异常分类处理

## 测试策略

### 单元测试

- 订单业务逻辑测试
- 事件发送功能测试
- 消息处理逻辑测试

### 集成测试

- 订单流程端到端测试
- 消息队列集成测试
- 数据库事务测试

### 压力测试

- 高并发订单创建测试
- 消息队列性能测试
- 数据库性能测试

---

## 最近更新记录

### 2025-09-18 - 修复过时API使用问题

#### 修复的过时API问题

##### 1. OrderServiceImpl.java 修复

- **问题1**: 使用了 `.toList()` 方法（Java 16+新增，可能不稳定）
    - **位置**: 第52行 `pageQuery()` 方法中的Stream操作
    - **修复前**: `.toList()`
    - **修复后**: `.collect(Collectors.toList())`
    - **原因**: 提高兼容性和稳定性，避免依赖Java 16+的新API

#### 修复结果

- ✅ 编译成功
- ✅ 分页查询功能正常
- ✅ 流式处理兼容性提升

#### 依赖版本

- **MyBatis Plus**: 3.5.13
- **Java Stream API**: 兼容 Java 17

## 服务配置

### 服务基本信息

- **服务名称**: order-service
- **运行端口**: 8084
- **认证方式**: OAuth2.1 JWT (通过网关访问 JWK 端点)
- **缓存时间**: 30分钟

### 关键配置

```yaml
server:
  port: 8084  # 通过环境变量配置

spring:
  application:
    name: order-service
  security:
    oauth2:
      resourceserver:
        jwt:
          jwk-set-uri: http://127.0.0.1:80/.well-known/jwks.json
          cache-duration: PT30M
  cloud:
    stream:
      rocketmq:
        binder:
          name-server: 127.0.0.1:39876
```

---

**更新时间**: 2025/9/23  
**版本**: v1.4.0  
**更新内容**: 更新依赖版本为 Spring Boot 3.5.3、Spring Cloud 2025.0.0，更新实际配置信息

**上一版本**:  
**更新时间**: 2025/9/18  
**版本**: v1.3.0  
**更新内容**: 修复过时API使用问题，提高代码兼容性

**上一版本**:  
**更新时间**: 2025/1/15  
**版本**: v1.2.0  
**更新内容**: 新增订单事件消息系统架构和实现
