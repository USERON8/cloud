# 认证授权服务开发文档

## 项目概述

认证授权服务 (auth-service) 是云商城微服务架构的核心安全组件，基于 Spring Security 6.x 和 OAuth2.1 标准实现，提供完整的身份认证、授权管理和 JWT 令牌服务。

### 主要功能

- OAuth2.1 授权服务器实现
- JWT 令牌生成、验证和管理
- PKCE (Proof Key for Code Exchange) 支持
- 多客户端类型支持 (Web应用、移动应用、服务间调用)
- 用户身份认证和授权管理
- JWK (JSON Web Key) 端点服务
- 令牌撤销和刷新机制

## 技术栈

### 核心框架

- **Spring Boot**: 3.5.3
- **Spring Cloud**: 2025.0.0
- **Spring Cloud Alibaba**: 2025.0.0.0-preview
- **Spring Security**: 6.x (OAuth2.1 实现)
- **Java版本**: 17 LTS

### 依赖版本

```xml
<spring-boot.version>3.5.3</spring-boot.version>
<spring-cloud.version>2025.0.0</spring-cloud.version>
<spring-cloud-alibaba.version>2025.0.0.0-preview</spring-cloud-alibaba.version>
<java.version>17</java.version>
<spring-security.version>6.x</spring-security.version>
```

### 数据存储

- **MySQL**: 8.0+ (用户、客户端信息存储)
- **Redis**: 7.0+ (令牌缓存、会话管理，数据库5)
- **RocketMQ**: 5.3.2 (审计日志消息，端口: 39876)

## OAuth2.1 架构设计

### 支持的授权流程

| 授权类型 | Grant Type | 客户端类型 | 使用场景 |
|----------|-----------|-----------|----------|
| 授权码模式 | authorization_code | Web应用 | 前端SPA应用 |
| 授权码模式+PKCE | authorization_code + PKCE | 移动应用 | iOS/Android应用 |
| 客户端凭据模式 | client_credentials | 服务端 | 微服务间调用 |

### 客户端配置

#### 1. Web 客户端 (web-client)

```yaml
web-client:
  client-id: web-client
  client-secret: WebClient@2024#Secure
  client-authentication-method: client_secret_basic
  authorization-grant-type: authorization_code
  redirect-uri: http://127.0.0.1:80/authorized
  scope: openid,profile,read,write,user.read,user.write,order.read,order.write
```

**特点**:
- 支持标准 OAuth2.1 授权码流程
- 适用于 Web 前端应用
- 通过网关统一入口进行回调

#### 2. 服务客户端 (client-service)

```yaml
client-service:
  client-id: client-service
  client-secret: ClientService@2024#Secure
  authorization-grant-type: client_credentials
  scope: internal_api,service.read,service.write
```

**特点**:
- 用于微服务间的服务到服务认证
- 无需用户交互，直接获取访问令牌
- 具有内部API访问权限

### JWT 令牌配置

#### 令牌有效期设置

- **测试模式** (`app.jwt.test-mode=true`): 365天有效期，便于API测试
- **生产模式** (`app.jwt.test-mode=false`): 2小时有效期，确保安全性

```yaml
app:
  jwt:
    test-mode: true  # 测试模式开关
    issuer: http://localhost:8080  # JWT发行者
    access-token-validity: PT2H  # 生产环境2小时
    test-token-validity: P365D   # 测试环境365天
```

#### RSA 密钥对管理

- 使用 RSA 算法签名 JWT 令牌
- 支持密钥轮换和多密钥验证
- 通过 JWK 端点 (`/.well-known/jwks.json`) 发布公钥

## 核心API端点

### OAuth2.1 标准端点

| 端点 | 方法 | 功能 | 标准 |
|------|------|------|------|
| `/oauth2/authorize` | GET | 授权端点 | RFC 6749 |
| `/oauth2/token` | POST | 令牌端点 | RFC 6749 |
| `/oauth2/introspect` | POST | 令牌内省 | RFC 7662 |
| `/oauth2/revoke` | POST | 令牌撤销 | RFC 7009 |
| `/.well-known/jwks.json` | GET | JWK公钥集 | RFC 7517 |
| `/.well-known/openid_configuration` | GET | 发现端点 | OpenID Connect |

### 自定义业务端点

| 端点 | 方法 | 功能 | 说明 |
|------|------|------|------|
| `/api/v1/auth/login` | POST | 用户登录 | 支持用户名/邮箱/手机号 |
| `/api/v1/auth/logout` | POST | 用户登出 | 撤销令牌并清理会话 |
| `/api/v1/auth/register` | POST | 用户注册 | 新用户账号注册 |
| `/api/v1/auth/refresh` | POST | 刷新令牌 | 使用refresh_token获取新令牌 |
| `/api/v1/auth/userinfo` | GET | 用户信息 | 获取当前认证用户信息 |

## 服务配置

### 服务基本信息

- **服务名称**: auth-service
- **运行端口**: 8080
- **数据库**: cloud_auth (MySQL)
- **Redis数据库**: 5 (令牌缓存专用)
- **日志级别**: DEBUG (开发阶段)

### 关键配置

```yaml
server:
  port: 8080

spring:
  application:
    name: auth-service
  datasource:
    url: jdbc:mysql://localhost:3306/cloud_auth?useUnicode=true&characterEncoding=utf-8&useSSL=false&serverTimezone=GMT%2B8&allowPublicKeyRetrieval=true
    username: root
    password: root
  data:
    redis:
      host: localhost
      port: 6379
      password: root
      database: 5  # 专用数据库
      timeout: 10000ms
  cloud:
    stream:
      rocketmq:
        binder:
          name-server: 127.0.0.1:39876
      bindings:
        log-in-0:
          destination: LOG_AUTH_TOPIC
          group: auth-log-group
```

## 数据库设计

### 用户表 (users)

```sql
CREATE TABLE `users` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `username` varchar(50) NOT NULL COMMENT '用户名',
  `password` varchar(255) NOT NULL COMMENT '密码(BCrypt加密)',
  `email` varchar(100) UNIQUE COMMENT '邮箱地址',
  `phone` varchar(20) UNIQUE COMMENT '手机号码',
  `enabled` tinyint NOT NULL DEFAULT 1 COMMENT '是否启用',
  `account_non_expired` tinyint NOT NULL DEFAULT 1 COMMENT '账户是否未过期',
  `account_non_locked` tinyint NOT NULL DEFAULT 1 COMMENT '账户是否未锁定',
  `credentials_non_expired` tinyint NOT NULL DEFAULT 1 COMMENT '凭据是否未过期',
  `created_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_username` (`username`),
  KEY `idx_email` (`email`),
  KEY `idx_phone` (`phone`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户信息表';
```

### 客户端表 (oauth2_registered_clients)

```sql
CREATE TABLE `oauth2_registered_clients` (
  `id` varchar(100) NOT NULL COMMENT '客户端ID',
  `client_id` varchar(100) NOT NULL COMMENT '客户端标识',
  `client_id_issued_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `client_secret` varchar(255) COMMENT '客户端密钥',
  `client_secret_expires_at` timestamp NULL,
  `client_name` varchar(200) NOT NULL COMMENT '客户端名称',
  `client_authentication_methods` varchar(1000) NOT NULL COMMENT '客户端认证方法',
  `authorization_grant_types` varchar(1000) NOT NULL COMMENT '授权类型',
  `redirect_uris` text COMMENT '重定向URI',
  `post_logout_redirect_uris` text COMMENT '登出重定向URI',
  `scopes` varchar(1000) NOT NULL COMMENT '权限范围',
  `client_settings` varchar(2000) NOT NULL COMMENT '客户端设置',
  `token_settings` varchar(2000) NOT NULL COMMENT '令牌设置',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_client_id` (`client_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='OAuth2客户端表';
```

## 安全特性

### 1. 密码安全

- 使用 BCrypt 算法加密存储用户密码
- 支持密码强度策略配置
- 防止彩虹表攻击

### 2. 令牌安全

- JWT 使用 RSA 算法签名，确保令牌完整性
- 支持令牌撤销和黑名单机制
- 令牌有效期可配置，平衡安全性和用户体验

### 3. CSRF 防护

- 在授权流程中实施 CSRF 保护
- 使用 state 参数防止跨站请求伪造

### 4. PKCE 支持

- 移动应用和公共客户端支持 PKCE
- 增强授权码交换的安全性
- 防止授权码拦截攻击

## 集成示例

### 1. Web 应用集成

```javascript
// 前端重定向到授权端点
const authorizeUrl = 'http://localhost:8080/oauth2/authorize' +
  '?response_type=code' +
  '&client_id=web-client' +
  '&redirect_uri=http://127.0.0.1:80/authorized' +
  '&scope=openid profile read write' +
  '&state=randomStateValue';

window.location.href = authorizeUrl;

// 授权回调处理
fetch('http://localhost:8080/oauth2/token', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/x-www-form-urlencoded',
    'Authorization': 'Basic ' + btoa('web-client:WebClient@2024#Secure')
  },
  body: new URLSearchParams({
    'grant_type': 'authorization_code',
    'code': authorizationCode,
    'redirect_uri': 'http://127.0.0.1:80/authorized',
    'client_id': 'web-client'
  })
});
```

### 2. 微服务集成

```java
@RestTemplate
public class ServiceClient {
    
    @Value("${app.oauth2.token-uri}")
    private String tokenUri;
    
    public String getServiceAccessToken() {
        RestTemplate restTemplate = new RestTemplate();
        
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);
        headers.setBasicAuth("client-service", "ClientService@2024#Secure");
        
        MultiValueMap<String, String> body = new LinkedMultiValueMap<>();
        body.add("grant_type", "client_credentials");
        body.add("scope", "internal_api service.read service.write");
        
        HttpEntity<MultiValueMap<String, String>> request = new HttpEntity<>(body, headers);
        TokenResponse response = restTemplate.postForObject(tokenUri, request, TokenResponse.class);
        
        return response.getAccessToken();
    }
}
```

## 监控和运维

### 关键监控指标

- 令牌签发成功率
- 用户认证成功率
- 客户端认证失败率
- 令牌验证延迟
- Redis 连接池状态

### 日志配置

```yaml
logging:
  level:
    com.cloud.auth: debug  # 认证服务详细日志
    org.springframework.security: debug  # Spring Security 调试
    org.springframework.web: warn  # Web请求日志
```

### 健康检查端点

- `/actuator/health` - 服务健康状态
- `/actuator/metrics` - 应用指标
- `/actuator/info` - 服务信息

## 测试指南

### API 测试

通过 Knife4j 文档界面进行 API 测试:
- 访问地址: http://localhost:8080/doc.html
- 支持在线测试所有认证相关接口
- 包含完整的请求参数说明和响应示例

### Postman 集成测试

1. **获取授权码**:
   - 浏览器访问授权端点
   - 用户登录并授权
   - 从回调URL获取授权码

2. **交换访问令牌**:
   ```
   POST /oauth2/token
   Authorization: Basic web-client:WebClient@2024#Secure
   Content-Type: application/x-www-form-urlencoded
   
   grant_type=authorization_code&code=AUTHORIZATION_CODE&redirect_uri=http://127.0.0.1:80/authorized
   ```

3. **使用访问令牌**:
   ```
   GET /api/v1/auth/userinfo
   Authorization: Bearer ACCESS_TOKEN
   ```

## 故障排查

### 常见问题

1. **令牌验证失败**: 检查 JWK 端点是否可访问
2. **客户端认证失败**: 确认客户端ID和密钥正确
3. **重定向URI错误**: 检查客户端配置中的重定向URI
4. **数据库连接问题**: 确认 cloud_auth 数据库存在

### 调试技巧

- 开启 Spring Security 调试日志
- 检查 Redis 令牌缓存状态
- 验证 JWT 令牌结构和签名
- 监控 OAuth2 端点访问日志

---

**更新时间**: 2025/9/23  
**版本**: v1.0.0  
**更新内容**: OAuth2.1 授权服务器完整实现文档，包含认证流程、令牌管理、安全特性等
