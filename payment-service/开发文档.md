# æ”¯ä»˜æœåŠ¡å¼€å‘æ–‡æ¡£

## é¡¹ç›®æ¦‚è¿°

æ”¯ä»˜æœåŠ¡ (payment-service) æ˜¯äº‘å•†åŸå¾®æœåŠ¡æ¶æ„ä¸­çš„å…³é”®ä¸šåŠ¡æœåŠ¡ï¼Œè´Ÿè´£æ”¯ä»˜æµç¨‹ç®¡ç†ã€ç¬¬ä¸‰æ–¹æ”¯ä»˜é›†æˆã€æ”¯ä»˜å›è°ƒå¤„ç†ç­‰åŠŸèƒ½ã€‚

### ä¸»è¦åŠŸèƒ½

- æ”¯ä»˜è®¢å•åˆ›å»ºå’Œç®¡ç†
- å¤šç§æ”¯ä»˜æ–¹å¼é›†æˆ (å¾®ä¿¡æ”¯ä»˜ã€æ”¯ä»˜å®ã€é“¶è”ç­‰)
- æ”¯ä»˜å›è°ƒå¤„ç†å’ŒéªŒç­¾
- é€€æ¬¾æµç¨‹ç®¡ç†
- æ”¯ä»˜äº‹ä»¶æ¶ˆæ¯å‘å¸ƒ
- æ”¯ä»˜å®‰å…¨æ§åˆ¶

## æŠ€æœ¯æ ˆ

### æ ¸å¿ƒæ¡†æ¶

- **Spring Boot**: 3.5.3
- **Spring Cloud**: 2025.0.0
- **Spring Cloud Alibaba**: 2025.0.0.0-preview
- **Spring Security OAuth2**: èµ„æºæœåŠ¡å™¨
- **Javaç‰ˆæœ¬**: 17 LTS

### ä¾èµ–ç‰ˆæœ¬

```xml
<spring-boot.version>3.5.3</spring-boot.version>
<spring-cloud.version>2025.0.0</spring-cloud.version>
<spring-cloud-alibaba.version>2025.0.0.0-preview</spring-cloud-alibaba.version>
<java.version>17</java.version>
<mybatis-plus.version>3.5.13</mybatis-plus.version>
```

### æ•°æ®å­˜å‚¨

- **MySQL**: 8.0+ (æ”¯ä»˜è®°å½•å­˜å‚¨ï¼Œæ•°æ®åº“: payment_db)
- **Redis**: 7.0+ (æ”¯ä»˜ç¼“å­˜ï¼Œæ•°æ®åº“4)
- **RocketMQ**: 5.3.2 (æ”¯ä»˜äº‹ä»¶æ¶ˆæ¯ï¼Œç«¯å£: 39876)

## æœåŠ¡é…ç½®

### æœåŠ¡åŸºæœ¬ä¿¡æ¯

- **æœåŠ¡åç§°**: payment-service
- **è¿è¡Œç«¯å£**: 8085
- **å¼€å‘çŠ¶æ€**: ğŸŸ¡ å¼€å‘ä¸­
- **æ•°æ®åº“**: payment_db (MySQL)
- **Redisæ•°æ®åº“**: 4 (æ”¯ä»˜ç¼“å­˜ä¸“ç”¨)
- **è®¤è¯æ–¹å¼**: OAuth2.1 JWT

### å…³é”®é…ç½®

```yaml
server:
  port: 8085

spring:
  application:
    name: payment-service
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/payment_db?useUnicode=true&characterEncoding=utf8&serverTimezone=GMT%2B8
    username: root
    password: root
  security:
    oauth2:
      resourceserver:
        jwt:
          jwk-set-uri: http://127.0.0.1:80/.well-known/jwks.json
          cache-duration: PT30M
  data:
    redis:
      host: localhost
      port: 6379
      password: root
      database: 4  # æ”¯ä»˜æœåŠ¡ä¸“ç”¨Redisæ•°æ®åº“
      timeout: 10000ms
  cloud:
    stream:
      rocketmq:
        binder:
          name-server: 127.0.0.1:39876
      bindings:
        payment-producer-out-0:
          destination: payment-events
          content-type: application/json
          group: payment-producer-group
```

## æ•°æ®åº“è®¾è®¡ (è§„åˆ’ä¸­)

### æ”¯ä»˜è®¢å•è¡¨ (payment_orders)

```sql
CREATE TABLE `payment_orders` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'æ”¯ä»˜ID',
  `payment_no` varchar(64) UNIQUE NOT NULL COMMENT 'æ”¯ä»˜å•å·',
  `order_id` bigint NOT NULL COMMENT 'è®¢å•ID',
  `order_no` varchar(64) NOT NULL COMMENT 'è®¢å•å·',
  `user_id` bigint NOT NULL COMMENT 'ç”¨æˆ·ID',
  `amount` decimal(10,2) NOT NULL COMMENT 'æ”¯ä»˜é‡‘é¢',
  `currency` varchar(10) NOT NULL DEFAULT 'CNY' COMMENT 'è´§å¸ç±»å‹',
  `payment_method` varchar(20) NOT NULL COMMENT 'æ”¯ä»˜æ–¹å¼',
  `payment_channel` varchar(20) COMMENT 'æ”¯ä»˜æ¸ é“',
  `third_party_no` varchar(64) COMMENT 'ç¬¬ä¸‰æ–¹æ”¯ä»˜å•å·',
  `status` tinyint NOT NULL DEFAULT 0 COMMENT 'æ”¯ä»˜çŠ¶æ€ï¼š0-å¾…æ”¯ä»˜ï¼Œ1-æ”¯ä»˜ä¸­ï¼Œ2-æ”¯ä»˜æˆåŠŸï¼Œ3-æ”¯ä»˜å¤±è´¥ï¼Œ4-å·²é€€æ¬¾',
  `callback_url` varchar(255) COMMENT 'å›è°ƒåœ°å€',
  `client_ip` varchar(50) COMMENT 'å®¢æˆ·ç«¯IP',
  `device_info` varchar(255) COMMENT 'è®¾å¤‡ä¿¡æ¯',
  `expire_time` datetime COMMENT 'è¿‡æœŸæ—¶é—´',
  `paid_time` datetime COMMENT 'æ”¯ä»˜æ—¶é—´',
  `created_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `deleted` tinyint NOT NULL DEFAULT 0 COMMENT 'é€»è¾‘åˆ é™¤',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_payment_no` (`payment_no`),
  KEY `idx_order_id` (`order_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æ”¯ä»˜è®¢å•è¡¨';
```

## æ”¯ä»˜äº‹ä»¶ç³»ç»Ÿ (è§„åˆ’ä¸­)

### æ”¯æŒçš„äº‹ä»¶ç±»å‹

| äº‹ä»¶ç±»å‹ | Tagæ ‡ç­¾ | è§¦å‘åœºæ™¯ | è¯´æ˜ |
|----------|---------|----------|------|
| PAYMENT_CREATED | payment-created | æ”¯ä»˜è®¢å•åˆ›å»º | æ–°æ”¯ä»˜è®¢å•ç”Ÿæˆ |
| PAYMENT_PROCESSING | payment-processing | æ”¯ä»˜å¤„ç†ä¸­ | ç¬¬ä¸‰æ–¹æ”¯ä»˜è°ƒç”¨ä¸­ |
| PAYMENT_SUCCESS | payment-success | æ”¯ä»˜æˆåŠŸ | æ”¯ä»˜å®Œæˆ |
| PAYMENT_FAILED | payment-failed | æ”¯ä»˜å¤±è´¥ | æ”¯ä»˜å¤„ç†å¤±è´¥ |
| PAYMENT_TIMEOUT | payment-timeout | æ”¯ä»˜è¶…æ—¶ | æ”¯ä»˜è®¢å•è¿‡æœŸ |
| REFUND_APPLIED | refund-applied | é€€æ¬¾ç”³è¯· | ç”¨æˆ·ç”³è¯·é€€æ¬¾ |
| REFUND_SUCCESS | refund-success | é€€æ¬¾æˆåŠŸ | é€€æ¬¾å¤„ç†å®Œæˆ |
| REFUND_FAILED | refund-failed | é€€æ¬¾å¤±è´¥ | é€€æ¬¾å¤„ç†å¤±è´¥ |

## APIè®¾è®¡ (è§„åˆ’ä¸­)

### æ”¯ä»˜ç®¡ç†æ¥å£

#### æ”¯ä»˜æ¥å£
- **POST** `/api/payment/create` - åˆ›å»ºæ”¯ä»˜è®¢å•
- **GET** `/api/payment/{paymentNo}` - æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€
- **POST** `/api/payment/{paymentNo}/pay` - å‘èµ·æ”¯ä»˜
- **POST** `/api/payment/callback/{channel}` - æ”¯ä»˜å›è°ƒæ¥å£
- **POST** `/api/payment/{paymentNo}/cancel` - å–æ¶ˆæ”¯ä»˜

#### é€€æ¬¾æ¥å£
- **POST** `/api/payment/{paymentNo}/refund` - ç”³è¯·é€€æ¬¾
- **GET** `/api/payment/{paymentNo}/refund/status` - æŸ¥è¯¢é€€æ¬¾çŠ¶æ€
- **POST** `/api/payment/refund/callback/{channel}` - é€€æ¬¾å›è°ƒæ¥å£

## ç¬¬ä¸‰æ–¹æ”¯ä»˜é›†æˆ (è§„åˆ’ä¸­)

### æ”¯æŒçš„æ”¯ä»˜æ–¹å¼

- **å¾®ä¿¡æ”¯ä»˜**: æ‰«ç æ”¯ä»˜ã€APPæ”¯ä»˜ã€å°ç¨‹åºæ”¯ä»˜
- **æ”¯ä»˜å®**: æ‰«ç æ”¯ä»˜ã€APPæ”¯ä»˜ã€ç½‘é¡µæ”¯ä»˜
- **é“¶è”æ”¯ä»˜**: ç½‘å…³æ”¯ä»˜ã€å¿«æ·æ”¯ä»˜
- **PayPal**: å›½é™…æ”¯ä»˜æ”¯æŒ

### æ”¯ä»˜å®‰å…¨

- æ”¯ä»˜å‚æ•°åŠ å¯†ä¼ è¾“
- å›è°ƒéªŒç­¾æœºåˆ¶
- é˜²é‡å¤æ”¯ä»˜æ§åˆ¶
- æ”¯ä»˜é‡‘é¢æ ¡éªŒ
- IPç™½åå•æ§åˆ¶

## å¼€å‘è®¡åˆ’

### Phase 1: åŸºç¡€æ”¯ä»˜åŠŸèƒ½ (å¼€å‘ä¸­)
- [ ] æ”¯ä»˜è®¢å•ç®¡ç†
- [ ] å¾®ä¿¡æ”¯ä»˜é›†æˆ
- [ ] æ”¯ä»˜å›è°ƒå¤„ç†
- [ ] åŸºç¡€é€€æ¬¾åŠŸèƒ½

### Phase 2: æ‰©å±•æ”¯ä»˜æ–¹å¼
- [ ] æ”¯ä»˜å®é›†æˆ
- [ ] é“¶è”æ”¯ä»˜é›†æˆ
- [ ] æ”¯ä»˜æ–¹å¼é€‰æ‹©ä¼˜åŒ–

### Phase 3: é«˜çº§åŠŸèƒ½
- [ ] åˆ†è´¦åŠŸèƒ½
- [ ] å®šæœŸæ”¯ä»˜
- [ ] æ”¯ä»˜é£æ§
- [ ] å›½é™…æ”¯ä»˜æ”¯æŒ

## æµ‹è¯•æŒ‡å—

### API æµ‹è¯•
- **æµ‹è¯•ç¯å¢ƒ**: ä½¿ç”¨æ”¯ä»˜æ–¹sandboxç¯å¢ƒ
- **Knife4jæ–‡æ¡£**: http://localhost/doc.html (å¼€å‘å®Œæˆå)
- **å›è°ƒæµ‹è¯•**: ä½¿ç”¨å†…ç½‘ç©¿é€å·¥å…·è¿›è¡Œå›è°ƒæµ‹è¯•

### å®‰å…¨æµ‹è¯•
- æ”¯ä»˜å‚æ•°ç¯¡æ”¹æµ‹è¯•
- é‡å¤æ”¯ä»˜æµ‹è¯•
- å¼‚å¸¸å›è°ƒæµ‹è¯•
- è¶…æ—¶åœºæ™¯æµ‹è¯•

## ç›‘æ§å’Œè¿ç»´

### å…³é”®ç›‘æ§æŒ‡æ ‡
- æ”¯ä»˜æˆåŠŸç‡
- æ”¯ä»˜å“åº”æ—¶é—´
- å›è°ƒæˆåŠŸç‡
- é€€æ¬¾æˆåŠŸç‡
- å¼‚å¸¸æ”¯ä»˜æ•°é‡

### æ—¥å¿—è¦æ±‚
- æ”¯ä»˜è®¢å•åˆ›å»ºæ—¥å¿—
- ç¬¬ä¸‰æ–¹æ”¯ä»˜è°ƒç”¨æ—¥å¿—
- å›è°ƒå¤„ç†æ—¥å¿—
- å¼‚å¸¸æ”¯ä»˜å‘Šè­¦æ—¥å¿—

---

**æ›´æ–°æ—¶é—´**: 2025/9/23  
**ç‰ˆæœ¬**: v0.1.0 (å¼€å‘ä¸­)  
**å¼€å‘çŠ¶æ€**: ğŸŸ¡ åŸºç¡€åŠŸèƒ½å¼€å‘ä¸­  
**ä¸‹ä¸€æ­¥è®¡åˆ’**: å®Œæˆæ”¯ä»˜è®¢å•ç®¡ç†å’Œå¾®ä¿¡æ”¯ä»˜é›†æˆ
