# 支付服务开发文档

## 项目概述

支付服务 (payment-service) 是云商城微服务架构中的关键业务服务，负责支付流程管理、第三方支付集成、支付回调处理等功能。

### 主要功能

- 支付订单创建和管理
- 多种支付方式集成 (微信支付、支付宝、银联等)
- 支付回调处理和验签
- 退款流程管理
- 支付事件消息发布
- 支付安全控制

## 技术栈

### 核心框架

- **Spring Boot**: 3.5.3
- **Spring Cloud**: 2025.0.0
- **Spring Cloud Alibaba**: 2025.0.0.0-preview
- **Spring Security OAuth2**: 资源服务器
- **Java版本**: 17 LTS

### 依赖版本

```xml
<spring-boot.version>3.5.3</spring-boot.version>
<spring-cloud.version>2025.0.0</spring-cloud.version>
<spring-cloud-alibaba.version>2025.0.0.0-preview</spring-cloud-alibaba.version>
<java.version>17</java.version>
<mybatis-plus.version>3.5.13</mybatis-plus.version>
```

### 数据存储

- **MySQL**: 8.0+ (支付记录存储，数据库: payment_db)
- **Redis**: 7.0+ (支付缓存，数据库4)
- **RocketMQ**: 5.3.2 (支付事件消息，端口: 39876)

## 服务配置

### 服务基本信息

- **服务名称**: payment-service
- **运行端口**: 8085
- **开发状态**: 🟡 开发中
- **数据库**: payment_db (MySQL)
- **Redis数据库**: 4 (支付缓存专用)
- **认证方式**: OAuth2.1 JWT

### 关键配置

```yaml
server:
  port: 8085

spring:
  application:
    name: payment-service
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/payment_db?useUnicode=true&characterEncoding=utf8&serverTimezone=GMT%2B8
    username: root
    password: root
  security:
    oauth2:
      resourceserver:
        jwt:
          jwk-set-uri: http://127.0.0.1:80/.well-known/jwks.json
          cache-duration: PT30M
  data:
    redis:
      host: localhost
      port: 6379
      password: root
      database: 4  # 支付服务专用Redis数据库
      timeout: 10000ms
  cloud:
    stream:
      rocketmq:
        binder:
          name-server: 127.0.0.1:39876
      bindings:
        payment-producer-out-0:
          destination: payment-events
          content-type: application/json
          group: payment-producer-group
```

## 数据库设计 (规划中)

### 支付订单表 (payment_orders)

```sql
CREATE TABLE `payment_orders` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '支付ID',
  `payment_no` varchar(64) UNIQUE NOT NULL COMMENT '支付单号',
  `order_id` bigint NOT NULL COMMENT '订单ID',
  `order_no` varchar(64) NOT NULL COMMENT '订单号',
  `user_id` bigint NOT NULL COMMENT '用户ID',
  `amount` decimal(10,2) NOT NULL COMMENT '支付金额',
  `currency` varchar(10) NOT NULL DEFAULT 'CNY' COMMENT '货币类型',
  `payment_method` varchar(20) NOT NULL COMMENT '支付方式',
  `payment_channel` varchar(20) COMMENT '支付渠道',
  `third_party_no` varchar(64) COMMENT '第三方支付单号',
  `status` tinyint NOT NULL DEFAULT 0 COMMENT '支付状态：0-待支付，1-支付中，2-支付成功，3-支付失败，4-已退款',
  `callback_url` varchar(255) COMMENT '回调地址',
  `client_ip` varchar(50) COMMENT '客户端IP',
  `device_info` varchar(255) COMMENT '设备信息',
  `expire_time` datetime COMMENT '过期时间',
  `paid_time` datetime COMMENT '支付时间',
  `created_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `deleted` tinyint NOT NULL DEFAULT 0 COMMENT '逻辑删除',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_payment_no` (`payment_no`),
  KEY `idx_order_id` (`order_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='支付订单表';
```

## 支付事件系统 (规划中)

### 支持的事件类型

| 事件类型 | Tag标签 | 触发场景 | 说明 |
|----------|---------|----------|------|
| PAYMENT_CREATED | payment-created | 支付订单创建 | 新支付订单生成 |
| PAYMENT_PROCESSING | payment-processing | 支付处理中 | 第三方支付调用中 |
| PAYMENT_SUCCESS | payment-success | 支付成功 | 支付完成 |
| PAYMENT_FAILED | payment-failed | 支付失败 | 支付处理失败 |
| PAYMENT_TIMEOUT | payment-timeout | 支付超时 | 支付订单过期 |
| REFUND_APPLIED | refund-applied | 退款申请 | 用户申请退款 |
| REFUND_SUCCESS | refund-success | 退款成功 | 退款处理完成 |
| REFUND_FAILED | refund-failed | 退款失败 | 退款处理失败 |

## API设计 (规划中)

### 支付管理接口

#### 支付接口
- **POST** `/api/payment/create` - 创建支付订单
- **GET** `/api/payment/{paymentNo}` - 查询支付状态
- **POST** `/api/payment/{paymentNo}/pay` - 发起支付
- **POST** `/api/payment/callback/{channel}` - 支付回调接口
- **POST** `/api/payment/{paymentNo}/cancel` - 取消支付

#### 退款接口
- **POST** `/api/payment/{paymentNo}/refund` - 申请退款
- **GET** `/api/payment/{paymentNo}/refund/status` - 查询退款状态
- **POST** `/api/payment/refund/callback/{channel}` - 退款回调接口

## 第三方支付集成 (规划中)

### 支持的支付方式

- **微信支付**: 扫码支付、APP支付、小程序支付
- **支付宝**: 扫码支付、APP支付、网页支付
- **银联支付**: 网关支付、快捷支付
- **PayPal**: 国际支付支持

### 支付安全

- 支付参数加密传输
- 回调验签机制
- 防重复支付控制
- 支付金额校验
- IP白名单控制

## 开发计划

### Phase 1: 基础支付功能 (开发中)
- [ ] 支付订单管理
- [ ] 微信支付集成
- [ ] 支付回调处理
- [ ] 基础退款功能

### Phase 2: 扩展支付方式
- [ ] 支付宝集成
- [ ] 银联支付集成
- [ ] 支付方式选择优化

### Phase 3: 高级功能
- [ ] 分账功能
- [ ] 定期支付
- [ ] 支付风控
- [ ] 国际支付支持

## 测试指南

### API 测试
- **测试环境**: 使用支付方sandbox环境
- **Knife4j文档**: http://localhost/doc.html (开发完成后)
- **回调测试**: 使用内网穿透工具进行回调测试

### 安全测试
- 支付参数篡改测试
- 重复支付测试
- 异常回调测试
- 超时场景测试

## 监控和运维

### 关键监控指标
- 支付成功率
- 支付响应时间
- 回调成功率
- 退款成功率
- 异常支付数量

### 日志要求
- 支付订单创建日志
- 第三方支付调用日志
- 回调处理日志
- 异常支付告警日志

---

**更新时间**: 2025/9/23  
**版本**: v0.1.0 (开发中)  
**开发状态**: 🟡 基础功能开发中  
**下一步计划**: 完成支付订单管理和微信支付集成
