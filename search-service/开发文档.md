# 搜索服务开发文档

## 项目概述

搜索服务 (search-service) 是云商城微服务架构中的搜索引擎服务，基于 Elasticsearch 提供高性能的商品搜索、用户搜索、订单搜索等功能。

### 主要功能

- 商品全文搜索和筛选
- 搜索建议和自动补全
- 搜索结果排序优化
- 搜索热词统计
- 索引管理和数据同步
- 搜索分析和推荐

## 技术栈

### 核心框架

- **Spring Boot**: 3.5.3
- **Spring Cloud**: 2025.0.0
- **Spring Cloud Alibaba**: 2025.0.0.0-preview
- **Spring Data Elasticsearch**: 5.x
- **Java版本**: 17 LTS

### 依赖版本

```xml

<spring-boot.version>3.5.3</spring-boot.version>
<spring-cloud.version>2025.0.0</spring-cloud.version>
<spring-cloud-alibaba.version>2025.0.0.0-preview</spring-cloud-alibaba.version>
<java.version>17</java.version>
<elasticsearch.version>8.x</elasticsearch.version>
```

### 数据存储

- **Elasticsearch**: 8.x+ (搜索引擎，端口: 9201)
- **Redis**: 7.0+ (搜索缓存，数据库5)
- **MySQL**: 8.0+ (搜索配置存储，数据库: search_db)
- **RocketMQ**: 5.3.2 (搜索事件消息，端口: 39876)

## 服务配置

### 服务基本信息

- **服务名称**: search-service
- **运行端口**: 8086
- **开发状态**: 🟡 开发中
- **搜索引擎**: Elasticsearch 8.x
- **Redis数据库**: 5 (搜索缓存专用)
- **认证方式**: OAuth2.1 JWT

### 关键配置

```yaml
server:
  port: 8086

spring:
  application:
    name: search-service
  security:
    oauth2:
      resourceserver:
        jwt:
          jwk-set-uri: http://127.0.0.1:80/.well-known/jwks.json
          cache-duration: PT30M
  data:
    redis:
      host: localhost
      port: 6379
      password: root
      database: 5  # 搜索服务专用Redis数据库
      timeout: 10000ms
    elasticsearch:
      repositories:
        enabled: true
      client:
        endpoints: localhost:9201
        username: elastic
        password: your_password
        connection-timeout: 10s
        socket-timeout: 30s
  cloud:
    stream:
      rocketmq:
        binder:
          name-server: 127.0.0.1:39876
      bindings:
        search-producer-out-0:
          destination: search-events
          content-type: application/json
          group: search-producer-group
```

## 索引设计 (规划中)

### 商品搜索索引 (product_index)

```json
{
  "mappings": {
    "properties": {
      "id": {
        "type": "long"
      },
      "productName": {
        "type": "text",
        "analyzer": "ik_max_word",
        "search_analyzer": "ik_smart",
        "fields": {
          "keyword": {
            "type": "keyword"
          }
        }
      },
      "categoryId": {
        "type": "long"
      },
      "categoryName": {
        "type": "text",
        "analyzer": "ik_max_word"
      },
      "brandName": {
        "type": "keyword"
      },
      "price": {
        "type": "scaled_float",
        "scaling_factor": 100
      },
      "salesCount": {
        "type": "integer"
      },
      "viewCount": {
        "type": "integer"
      },
      "status": {
        "type": "byte"
      },
      "isHot": {
        "type": "boolean"
      },
      "isNew": {
        "type": "boolean"
      },
      "tags": {
        "type": "keyword"
      },
      "description": {
        "type": "text",
        "analyzer": "ik_max_word"
      },
      "images": {
        "type": "keyword"
      },
      "createdTime": {
        "type": "date"
      },
      "updatedTime": {
        "type": "date"
      }
    }
  },
  "settings": {
    "number_of_shards": 3,
    "number_of_replicas": 1,
    "analysis": {
      "analyzer": {
        "ik_max_word": {
          "type": "ik_max_word"
        },
        "ik_smart": {
          "type": "ik_smart"
        }
      }
    }
  }
}
```

### 搜索日志索引 (search_log_index)

```json
{
  "mappings": {
    "properties": {
      "id": {
        "type": "keyword"
      },
      "userId": {
        "type": "long"
      },
      "keyword": {
        "type": "text",
        "analyzer": "ik_max_word",
        "fields": {
          "keyword": {
            "type": "keyword"
          }
        }
      },
      "searchType": {
        "type": "keyword"
      },
      "resultCount": {
        "type": "integer"
      },
      "clickedProductId": {
        "type": "long"
      },
      "searchTime": {
        "type": "date"
      },
      "responseTime": {
        "type": "integer"
      },
      "clientIp": {
        "type": "ip"
      },
      "userAgent": {
        "type": "text"
      }
    }
  }
}
```

## API设计 (规划中)

### 搜索接口

#### 商品搜索

- **GET** `/api/search/products` - 商品全文搜索
- **GET** `/api/search/products/suggest` - 搜索建议
- **GET** `/api/search/products/completion` - 自动补全
- **GET** `/api/search/products/filters` - 获取搜索过滤条件
- **GET** `/api/search/hot-keywords` - 热门搜索词

#### 高级搜索

- **POST** `/api/search/products/advanced` - 高级搜索
- **GET** `/api/search/products/similar/{productId}` - 相似商品推荐
- **GET** `/api/search/products/category/{categoryId}` - 分类商品搜索

### 管理接口

#### 索引管理

- **POST** `/api/search/admin/index/create` - 创建索引
- **DELETE** `/api/search/admin/index/{indexName}` - 删除索引
- **POST** `/api/search/admin/index/reindex` - 重建索引
- **GET** `/api/search/admin/index/status` - 索引状态

#### 数据同步

- **POST** `/api/search/admin/sync/products` - 同步商品数据
- **POST** `/api/search/admin/sync/incremental` - 增量同步
- **GET** `/api/search/admin/sync/status` - 同步状态

## 搜索功能实现 (规划中)

### 全文搜索

```java

@Service
public class ProductSearchService {

    public SearchResult<ProductDocument> searchProducts(ProductSearchRequest request) {
        // 构建搜索查询
        BoolQueryBuilder boolQuery = QueryBuilders.boolQuery();

        // 关键词搜索
        if (StringUtils.hasText(request.getKeyword())) {
            boolQuery.should(QueryBuilders.multiMatchQuery(request.getKeyword())
                    .field("productName", 2.0f)  // 商品名称权重更高
                    .field("description", 1.0f)
                    .field("categoryName", 1.5f)
                    .type(MultiMatchQueryBuilder.Type.BEST_FIELDS));
        }

        // 分类过滤
        if (request.getCategoryId() != null) {
            boolQuery.filter(QueryBuilders.termQuery("categoryId", request.getCategoryId()));
        }

        // 价格区间过滤
        if (request.getMinPrice() != null || request.getMaxPrice() != null) {
            RangeQueryBuilder priceRange = QueryBuilders.rangeQuery("price");
            if (request.getMinPrice() != null) priceRange.gte(request.getMinPrice());
            if (request.getMaxPrice() != null) priceRange.lte(request.getMaxPrice());
            boolQuery.filter(priceRange);
        }

        // 构建搜索请求
        SearchRequest searchRequest = new SearchRequest("product_index");
        SearchSourceBuilder sourceBuilder = new SearchSourceBuilder()
                .query(boolQuery)
                .from(request.getFrom())
                .size(request.getSize())
                .sort(buildSortConditions(request.getSortBy()))
                .highlighter(buildHighlighter());

        // 执行搜索
        SearchResponse response = elasticsearchClient.search(searchRequest, RequestOptions.DEFAULT);

        // 解析结果
        return parseSearchResponse(response);
    }
}
```

### 搜索建议

```java

@Service
public class SearchSuggestionService {

    public List<String> getSuggestions(String keyword) {
        // 使用completion suggester
        CompletionSuggestionBuilder suggestionBuilder = SuggestBuilders
                .completionSuggestion("suggest")
                .prefix(keyword)
                .size(10);

        SuggestBuilder suggestBuilder = new SuggestBuilder()
                .addSuggestion("product_suggest", suggestionBuilder);

        SearchRequest searchRequest = new SearchRequest("product_index")
                .source(new SearchSourceBuilder().suggest(suggestBuilder));

        SearchResponse response = elasticsearchClient.search(searchRequest, RequestOptions.DEFAULT);

        return parseSuggestionResponse(response);
    }
}
```

## 数据同步 (规划中)

### 实时同步

```java

@Component
public class DataSyncConsumer {

    @RocketMQMessageListener(topic = "product-events", consumerGroup = "search-sync-group")
    public void onProductEvent(ProductChangeEvent event) {
        switch (event.getEventType()) {
            case "PRODUCT_CREATED":
            case "PRODUCT_UPDATED":
                syncProductToES(event.getProductId());
                break;
            case "PRODUCT_DELETED":
                deleteProductFromES(event.getProductId());
                break;
            case "PRODUCT_STATUS_CHANGED":
                updateProductStatus(event.getProductId(), event.getStatus());
                break;
        }
    }

    private void syncProductToES(Long productId) {
        // 从product-service获取商品详情
        ProductDetail product = productClient.getProductById(productId);

        // 转换为ES文档
        ProductDocument document = convertToDocument(product);

        // 保存到ES
        productSearchRepository.save(document);

        log.info("商品同步到ES成功: productId={}", productId);
    }
}
```

### 批量同步

```java

@Service
public class BatchSyncService {

    public void syncAllProducts() {
        int pageSize = 1000;
        int pageNum = 1;

        while (true) {
            // 批量获取商品数据
            List<ProductDetail> products = productClient.getProductsByPage(pageNum, pageSize);
            if (products.isEmpty()) {
                break;
            }

            // 批量转换为ES文档
            List<ProductDocument> documents = products.stream()
                    .map(this::convertToDocument)
                    .collect(Collectors.toList());

            // 批量保存到ES
            productSearchRepository.saveAll(documents);

            log.info("批量同步商品到ES: pageNum={}, count={}", pageNum, documents.size());
            pageNum++;
        }
    }
}
```

## 搜索分析 (规划中)

### 搜索统计

- 搜索热词统计
- 搜索结果点击率分析
- 零结果搜索分析
- 用户搜索行为分析

### 搜索优化

- 基于搜索日志的相关性调优
- 搜索结果排序优化
- 个性化搜索推荐
- A/B测试支持

## 开发计划

### Phase 1: 基础搜索功能 (开发中)

- [ ] Elasticsearch集成配置
- [ ] 商品索引设计和创建
- [ ] 基础全文搜索功能
- [ ] 数据同步机制

### Phase 2: 高级搜索功能

- [ ] 搜索建议和自动补全
- [ ] 高级筛选和排序
- [ ] 搜索结果高亮
- [ ] 相似商品推荐

### Phase 3: 搜索分析和优化

- [ ] 搜索日志收集
- [ ] 搜索统计分析
- [ ] 个性化搜索
- [ ] 搜索性能优化

## 测试指南

### 功能测试

- **搜索准确性**: 验证搜索结果的准确性和相关性
- **性能测试**: 搜索响应时间和并发能力
- **索引测试**: 数据同步的准确性和及时性

### API 测试

- **Knife4j文档**: http://localhost/doc.html (开发完成后)
- **搜索接口**: 测试各种搜索场景和参数组合
- **管理接口**: 测试索引管理和数据同步功能

## 监控和运维

### 关键监控指标

- 搜索请求量和响应时间
- 搜索成功率
- Elasticsearch集群状态
- 索引大小和文档数量
- 数据同步延迟

### 日志要求

- 搜索请求和响应日志
- 数据同步操作日志
- Elasticsearch操作日志
- 性能监控日志

---

**更新时间**: 2025/9/23  
**版本**: v0.1.0 (开发中)  
**开发状态**: 🟡 基础功能规划中  
**下一步计划**: 完成Elasticsearch集成和商品索引设计
