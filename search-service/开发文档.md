# æœç´¢æœåŠ¡å¼€å‘æ–‡æ¡£

## é¡¹ç›®æ¦‚è¿°

æœç´¢æœåŠ¡ (search-service) æ˜¯äº‘å•†åŸå¾®æœåŠ¡æ¶æ„ä¸­çš„æœç´¢å¼•æ“æœåŠ¡ï¼ŒåŸºäº Elasticsearch æä¾›é«˜æ€§èƒ½çš„å•†å“æœç´¢ã€ç”¨æˆ·æœç´¢ã€è®¢å•æœç´¢ç­‰åŠŸèƒ½ã€‚

### ä¸»è¦åŠŸèƒ½

- å•†å“å…¨æ–‡æœç´¢å’Œç­›é€‰
- æœç´¢å»ºè®®å’Œè‡ªåŠ¨è¡¥å…¨
- æœç´¢ç»“æœæ’åºä¼˜åŒ–
- æœç´¢çƒ­è¯ç»Ÿè®¡
- ç´¢å¼•ç®¡ç†å’Œæ•°æ®åŒæ­¥
- æœç´¢åˆ†æå’Œæ¨è

## æŠ€æœ¯æ ˆ

### æ ¸å¿ƒæ¡†æ¶

- **Spring Boot**: 3.5.3
- **Spring Cloud**: 2025.0.0
- **Spring Cloud Alibaba**: 2025.0.0.0-preview
- **Spring Data Elasticsearch**: 5.x
- **Javaç‰ˆæœ¬**: 17 LTS

### ä¾èµ–ç‰ˆæœ¬

```xml

<spring-boot.version>3.5.3</spring-boot.version>
<spring-cloud.version>2025.0.0</spring-cloud.version>
<spring-cloud-alibaba.version>2025.0.0.0-preview</spring-cloud-alibaba.version>
<java.version>17</java.version>
<elasticsearch.version>8.x</elasticsearch.version>
```

### æ•°æ®å­˜å‚¨

- **Elasticsearch**: 8.x+ (æœç´¢å¼•æ“ï¼Œç«¯å£: 9201)
- **Redis**: 7.0+ (æœç´¢ç¼“å­˜ï¼Œæ•°æ®åº“5)
- **MySQL**: 8.0+ (æœç´¢é…ç½®å­˜å‚¨ï¼Œæ•°æ®åº“: search_db)
- **RocketMQ**: 5.3.2 (æœç´¢äº‹ä»¶æ¶ˆæ¯ï¼Œç«¯å£: 39876)

## æœåŠ¡é…ç½®

### æœåŠ¡åŸºæœ¬ä¿¡æ¯

- **æœåŠ¡åç§°**: search-service
- **è¿è¡Œç«¯å£**: 8086
- **å¼€å‘çŠ¶æ€**: ğŸŸ¡ å¼€å‘ä¸­
- **æœç´¢å¼•æ“**: Elasticsearch 8.x
- **Redisæ•°æ®åº“**: 5 (æœç´¢ç¼“å­˜ä¸“ç”¨)
- **è®¤è¯æ–¹å¼**: OAuth2.1 JWT

### å…³é”®é…ç½®

```yaml
server:
  port: 8086

spring:
  application:
    name: search-service
  security:
    oauth2:
      resourceserver:
        jwt:
          jwk-set-uri: http://127.0.0.1:80/.well-known/jwks.json
          cache-duration: PT30M
  data:
    redis:
      host: localhost
      port: 6379
      password: root
      database: 5  # æœç´¢æœåŠ¡ä¸“ç”¨Redisæ•°æ®åº“
      timeout: 10000ms
    elasticsearch:
      repositories:
        enabled: true
      client:
        endpoints: localhost:9201
        username: elastic
        password: your_password
        connection-timeout: 10s
        socket-timeout: 30s
  cloud:
    stream:
      rocketmq:
        binder:
          name-server: 127.0.0.1:39876
      bindings:
        search-producer-out-0:
          destination: search-events
          content-type: application/json
          group: search-producer-group
```

## ç´¢å¼•è®¾è®¡ (è§„åˆ’ä¸­)

### å•†å“æœç´¢ç´¢å¼• (product_index)

```json
{
  "mappings": {
    "properties": {
      "id": {
        "type": "long"
      },
      "productName": {
        "type": "text",
        "analyzer": "ik_max_word",
        "search_analyzer": "ik_smart",
        "fields": {
          "keyword": {
            "type": "keyword"
          }
        }
      },
      "categoryId": {
        "type": "long"
      },
      "categoryName": {
        "type": "text",
        "analyzer": "ik_max_word"
      },
      "brandName": {
        "type": "keyword"
      },
      "price": {
        "type": "scaled_float",
        "scaling_factor": 100
      },
      "salesCount": {
        "type": "integer"
      },
      "viewCount": {
        "type": "integer"
      },
      "status": {
        "type": "byte"
      },
      "isHot": {
        "type": "boolean"
      },
      "isNew": {
        "type": "boolean"
      },
      "tags": {
        "type": "keyword"
      },
      "description": {
        "type": "text",
        "analyzer": "ik_max_word"
      },
      "images": {
        "type": "keyword"
      },
      "createdTime": {
        "type": "date"
      },
      "updatedTime": {
        "type": "date"
      }
    }
  },
  "settings": {
    "number_of_shards": 3,
    "number_of_replicas": 1,
    "analysis": {
      "analyzer": {
        "ik_max_word": {
          "type": "ik_max_word"
        },
        "ik_smart": {
          "type": "ik_smart"
        }
      }
    }
  }
}
```

### æœç´¢æ—¥å¿—ç´¢å¼• (search_log_index)

```json
{
  "mappings": {
    "properties": {
      "id": {
        "type": "keyword"
      },
      "userId": {
        "type": "long"
      },
      "keyword": {
        "type": "text",
        "analyzer": "ik_max_word",
        "fields": {
          "keyword": {
            "type": "keyword"
          }
        }
      },
      "searchType": {
        "type": "keyword"
      },
      "resultCount": {
        "type": "integer"
      },
      "clickedProductId": {
        "type": "long"
      },
      "searchTime": {
        "type": "date"
      },
      "responseTime": {
        "type": "integer"
      },
      "clientIp": {
        "type": "ip"
      },
      "userAgent": {
        "type": "text"
      }
    }
  }
}
```

## APIè®¾è®¡ (è§„åˆ’ä¸­)

### æœç´¢æ¥å£

#### å•†å“æœç´¢

- **GET** `/api/search/products` - å•†å“å…¨æ–‡æœç´¢
- **GET** `/api/search/products/suggest` - æœç´¢å»ºè®®
- **GET** `/api/search/products/completion` - è‡ªåŠ¨è¡¥å…¨
- **GET** `/api/search/products/filters` - è·å–æœç´¢è¿‡æ»¤æ¡ä»¶
- **GET** `/api/search/hot-keywords` - çƒ­é—¨æœç´¢è¯

#### é«˜çº§æœç´¢

- **POST** `/api/search/products/advanced` - é«˜çº§æœç´¢
- **GET** `/api/search/products/similar/{productId}` - ç›¸ä¼¼å•†å“æ¨è
- **GET** `/api/search/products/category/{categoryId}` - åˆ†ç±»å•†å“æœç´¢

### ç®¡ç†æ¥å£

#### ç´¢å¼•ç®¡ç†

- **POST** `/api/search/admin/index/create` - åˆ›å»ºç´¢å¼•
- **DELETE** `/api/search/admin/index/{indexName}` - åˆ é™¤ç´¢å¼•
- **POST** `/api/search/admin/index/reindex` - é‡å»ºç´¢å¼•
- **GET** `/api/search/admin/index/status` - ç´¢å¼•çŠ¶æ€

#### æ•°æ®åŒæ­¥

- **POST** `/api/search/admin/sync/products` - åŒæ­¥å•†å“æ•°æ®
- **POST** `/api/search/admin/sync/incremental` - å¢é‡åŒæ­¥
- **GET** `/api/search/admin/sync/status` - åŒæ­¥çŠ¶æ€

## æœç´¢åŠŸèƒ½å®ç° (è§„åˆ’ä¸­)

### å…¨æ–‡æœç´¢

```java

@Service
public class ProductSearchService {

    public SearchResult<ProductDocument> searchProducts(ProductSearchRequest request) {
        // æ„å»ºæœç´¢æŸ¥è¯¢
        BoolQueryBuilder boolQuery = QueryBuilders.boolQuery();

        // å…³é”®è¯æœç´¢
        if (StringUtils.hasText(request.getKeyword())) {
            boolQuery.should(QueryBuilders.multiMatchQuery(request.getKeyword())
                    .field("productName", 2.0f)  // å•†å“åç§°æƒé‡æ›´é«˜
                    .field("description", 1.0f)
                    .field("categoryName", 1.5f)
                    .type(MultiMatchQueryBuilder.Type.BEST_FIELDS));
        }

        // åˆ†ç±»è¿‡æ»¤
        if (request.getCategoryId() != null) {
            boolQuery.filter(QueryBuilders.termQuery("categoryId", request.getCategoryId()));
        }

        // ä»·æ ¼åŒºé—´è¿‡æ»¤
        if (request.getMinPrice() != null || request.getMaxPrice() != null) {
            RangeQueryBuilder priceRange = QueryBuilders.rangeQuery("price");
            if (request.getMinPrice() != null) priceRange.gte(request.getMinPrice());
            if (request.getMaxPrice() != null) priceRange.lte(request.getMaxPrice());
            boolQuery.filter(priceRange);
        }

        // æ„å»ºæœç´¢è¯·æ±‚
        SearchRequest searchRequest = new SearchRequest("product_index");
        SearchSourceBuilder sourceBuilder = new SearchSourceBuilder()
                .query(boolQuery)
                .from(request.getFrom())
                .size(request.getSize())
                .sort(buildSortConditions(request.getSortBy()))
                .highlighter(buildHighlighter());

        // æ‰§è¡Œæœç´¢
        SearchResponse response = elasticsearchClient.search(searchRequest, RequestOptions.DEFAULT);

        // è§£æç»“æœ
        return parseSearchResponse(response);
    }
}
```

### æœç´¢å»ºè®®

```java

@Service
public class SearchSuggestionService {

    public List<String> getSuggestions(String keyword) {
        // ä½¿ç”¨completion suggester
        CompletionSuggestionBuilder suggestionBuilder = SuggestBuilders
                .completionSuggestion("suggest")
                .prefix(keyword)
                .size(10);

        SuggestBuilder suggestBuilder = new SuggestBuilder()
                .addSuggestion("product_suggest", suggestionBuilder);

        SearchRequest searchRequest = new SearchRequest("product_index")
                .source(new SearchSourceBuilder().suggest(suggestBuilder));

        SearchResponse response = elasticsearchClient.search(searchRequest, RequestOptions.DEFAULT);

        return parseSuggestionResponse(response);
    }
}
```

## æ•°æ®åŒæ­¥ (è§„åˆ’ä¸­)

### å®æ—¶åŒæ­¥

```java

@Component
public class DataSyncConsumer {

    @RocketMQMessageListener(topic = "product-events", consumerGroup = "search-sync-group")
    public void onProductEvent(ProductChangeEvent event) {
        switch (event.getEventType()) {
            case "PRODUCT_CREATED":
            case "PRODUCT_UPDATED":
                syncProductToES(event.getProductId());
                break;
            case "PRODUCT_DELETED":
                deleteProductFromES(event.getProductId());
                break;
            case "PRODUCT_STATUS_CHANGED":
                updateProductStatus(event.getProductId(), event.getStatus());
                break;
        }
    }

    private void syncProductToES(Long productId) {
        // ä»product-serviceè·å–å•†å“è¯¦æƒ…
        ProductDetail product = productClient.getProductById(productId);

        // è½¬æ¢ä¸ºESæ–‡æ¡£
        ProductDocument document = convertToDocument(product);

        // ä¿å­˜åˆ°ES
        productSearchRepository.save(document);

        log.info("å•†å“åŒæ­¥åˆ°ESæˆåŠŸ: productId={}", productId);
    }
}
```

### æ‰¹é‡åŒæ­¥

```java

@Service
public class BatchSyncService {

    public void syncAllProducts() {
        int pageSize = 1000;
        int pageNum = 1;

        while (true) {
            // æ‰¹é‡è·å–å•†å“æ•°æ®
            List<ProductDetail> products = productClient.getProductsByPage(pageNum, pageSize);
            if (products.isEmpty()) {
                break;
            }

            // æ‰¹é‡è½¬æ¢ä¸ºESæ–‡æ¡£
            List<ProductDocument> documents = products.stream()
                    .map(this::convertToDocument)
                    .collect(Collectors.toList());

            // æ‰¹é‡ä¿å­˜åˆ°ES
            productSearchRepository.saveAll(documents);

            log.info("æ‰¹é‡åŒæ­¥å•†å“åˆ°ES: pageNum={}, count={}", pageNum, documents.size());
            pageNum++;
        }
    }
}
```

## æœç´¢åˆ†æ (è§„åˆ’ä¸­)

### æœç´¢ç»Ÿè®¡

- æœç´¢çƒ­è¯ç»Ÿè®¡
- æœç´¢ç»“æœç‚¹å‡»ç‡åˆ†æ
- é›¶ç»“æœæœç´¢åˆ†æ
- ç”¨æˆ·æœç´¢è¡Œä¸ºåˆ†æ

### æœç´¢ä¼˜åŒ–

- åŸºäºæœç´¢æ—¥å¿—çš„ç›¸å…³æ€§è°ƒä¼˜
- æœç´¢ç»“æœæ’åºä¼˜åŒ–
- ä¸ªæ€§åŒ–æœç´¢æ¨è
- A/Bæµ‹è¯•æ”¯æŒ

## å¼€å‘è®¡åˆ’

### Phase 1: åŸºç¡€æœç´¢åŠŸèƒ½ (å¼€å‘ä¸­)

- [ ] Elasticsearché›†æˆé…ç½®
- [ ] å•†å“ç´¢å¼•è®¾è®¡å’Œåˆ›å»º
- [ ] åŸºç¡€å…¨æ–‡æœç´¢åŠŸèƒ½
- [ ] æ•°æ®åŒæ­¥æœºåˆ¶

### Phase 2: é«˜çº§æœç´¢åŠŸèƒ½

- [ ] æœç´¢å»ºè®®å’Œè‡ªåŠ¨è¡¥å…¨
- [ ] é«˜çº§ç­›é€‰å’Œæ’åº
- [ ] æœç´¢ç»“æœé«˜äº®
- [ ] ç›¸ä¼¼å•†å“æ¨è

### Phase 3: æœç´¢åˆ†æå’Œä¼˜åŒ–

- [ ] æœç´¢æ—¥å¿—æ”¶é›†
- [ ] æœç´¢ç»Ÿè®¡åˆ†æ
- [ ] ä¸ªæ€§åŒ–æœç´¢
- [ ] æœç´¢æ€§èƒ½ä¼˜åŒ–

## æµ‹è¯•æŒ‡å—

### åŠŸèƒ½æµ‹è¯•

- **æœç´¢å‡†ç¡®æ€§**: éªŒè¯æœç´¢ç»“æœçš„å‡†ç¡®æ€§å’Œç›¸å…³æ€§
- **æ€§èƒ½æµ‹è¯•**: æœç´¢å“åº”æ—¶é—´å’Œå¹¶å‘èƒ½åŠ›
- **ç´¢å¼•æµ‹è¯•**: æ•°æ®åŒæ­¥çš„å‡†ç¡®æ€§å’ŒåŠæ—¶æ€§

### API æµ‹è¯•

- **Knife4jæ–‡æ¡£**: http://localhost/doc.html (å¼€å‘å®Œæˆå)
- **æœç´¢æ¥å£**: æµ‹è¯•å„ç§æœç´¢åœºæ™¯å’Œå‚æ•°ç»„åˆ
- **ç®¡ç†æ¥å£**: æµ‹è¯•ç´¢å¼•ç®¡ç†å’Œæ•°æ®åŒæ­¥åŠŸèƒ½

## ç›‘æ§å’Œè¿ç»´

### å…³é”®ç›‘æ§æŒ‡æ ‡

- æœç´¢è¯·æ±‚é‡å’Œå“åº”æ—¶é—´
- æœç´¢æˆåŠŸç‡
- Elasticsearché›†ç¾¤çŠ¶æ€
- ç´¢å¼•å¤§å°å’Œæ–‡æ¡£æ•°é‡
- æ•°æ®åŒæ­¥å»¶è¿Ÿ

### æ—¥å¿—è¦æ±‚

- æœç´¢è¯·æ±‚å’Œå“åº”æ—¥å¿—
- æ•°æ®åŒæ­¥æ“ä½œæ—¥å¿—
- Elasticsearchæ“ä½œæ—¥å¿—
- æ€§èƒ½ç›‘æ§æ—¥å¿—

---

**æ›´æ–°æ—¶é—´**: 2025/9/23  
**ç‰ˆæœ¬**: v0.1.0 (å¼€å‘ä¸­)  
**å¼€å‘çŠ¶æ€**: ğŸŸ¡ åŸºç¡€åŠŸèƒ½è§„åˆ’ä¸­  
**ä¸‹ä¸€æ­¥è®¡åˆ’**: å®ŒæˆElasticsearché›†æˆå’Œå•†å“ç´¢å¼•è®¾è®¡
