<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cloud.stock.mapper.StockMapper">

    <resultMap id="BaseResultMap" type="com.cloud.stock.module.entity.Stock">
        <id property="id" column="id"/>
        <result property="productId" column="product_id"/>
        <result property="productName" column="product_name"/>
        <result property="stockQuantity" column="stock_quantity"/>
        <result property="frozenQuantity" column="frozen_quantity"/>
        <result property="stockStatus" column="stock_status"/>
        <result property="version" column="version"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="deleted" column="deleted"/>
    </resultMap>

    <sql id="Base_Column_List">
        id,product_id,product_name,stock_quantity,frozen_quantity,
        stock_status,version,created_at,updated_at,deleted
    </sql>

    <!-- 更新库存数量 -->
    <update id="updateStockQuantity">
        UPDATE stock
        SET stock_quantity = stock_quantity + #{quantity},
            version        = version + 1,
            updated_at     = NOW()
        WHERE id = #{stockId}
          AND stock_quantity + #{quantity} >= 0
          AND deleted = 0
    </update>

    <!-- 冻结库存 -->
    <update id="freezeStock">
        UPDATE stock
        SET frozen_quantity = frozen_quantity + #{quantity},
            version         = version + 1,
            updated_at      = NOW()
        WHERE id = #{stockId}
          AND stock_quantity - frozen_quantity >= #{quantity}
          AND deleted = 0
    </update>

    <!-- 解冻库存 -->
    <update id="unfreezeStock">
        UPDATE stock
        SET frozen_quantity = frozen_quantity - #{quantity},
            version         = version + 1,
            updated_at      = NOW()
        WHERE id = #{stockId}
          AND frozen_quantity >= #{quantity}
          AND deleted = 0
    </update>
</mapper>
