# æ—¥å¿—æœåŠ¡å¼€å‘æ–‡æ¡£

## é¡¹ç›®æ¦‚è¿°

æ—¥å¿—æœåŠ¡è´Ÿè´£æ¶ˆè´¹å„ä¸ªä¸šåŠ¡æœåŠ¡äº§ç”Ÿçš„äº‹ä»¶æ¶ˆæ¯ï¼Œè¿›è¡Œæ•°æ®å¤„ç†ã€è„±æ•ã€è½¬æ¢åå­˜å‚¨åˆ°Elasticsearchï¼Œä¸ºç³»ç»Ÿæä¾›ç»Ÿä¸€çš„æ—¥å¿—æŸ¥è¯¢ã€åˆ†æå’Œç›‘æ§èƒ½åŠ›ã€‚

## æŠ€æœ¯æ ˆ

### æ ¸å¿ƒæ¡†æ¶

- **Spring Boot**: 3.5.3
- **Spring Cloud**: 2025.0.0
- **Spring Cloud Alibaba**: 2025.0.0.0-preview
- **Spring Cloud Stream**: RocketMQ Binder
- **Javaç‰ˆæœ¬**: 17 LTS

### ä¾èµ–ç‰ˆæœ¬

```xml
<spring-boot.version>3.5.3</spring-boot.version>
<spring-cloud.version>2025.0.0</spring-cloud.version>
<spring-cloud-alibaba.version>2025.0.0.0-preview</spring-cloud-alibaba.version>
<java.version>17</java.version>
```

### æ•°æ®å­˜å‚¨

- **Elasticsearch**: 8.x+ (æ—¥å¿—äº‹ä»¶å­˜å‚¨å’Œæœç´¢ï¼Œç«¯å£: 9201)
- **RocketMQ**: 5.3.2 (æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç«¯å£: 39876)
- **Redis**: 7.0+ (ç¼“å­˜ï¼Œæ•°æ®åº“0)

## è®¢å•äº‹ä»¶æ¶ˆè´¹ç³»ç»Ÿ

### ç³»ç»Ÿæ¶æ„

#### 1. æ¶ˆæ¯æ¶ˆè´¹æ¶æ„

åŸºäºé˜¿é‡Œå·´å·´Spring Cloud Alibabaå®˜æ–¹ç¤ºä¾‹æ ‡å‡†å®ç°ï¼š

- **æ¶ˆæ¯æ¶ˆè´¹è€…**: ä½¿ç”¨å‡½æ•°å¼ç¼–ç¨‹æ¨¡å‹æ¶ˆè´¹RocketMQæ¶ˆæ¯
- **äº‹ä»¶å¤„ç†å™¨**: å¤„ç†ä¸šåŠ¡é€»è¾‘ã€æ•°æ®è½¬æ¢å’Œè„±æ•
- **æ•°æ®å­˜å‚¨å±‚**: åŸºäºSpring Data Elasticsearchå­˜å‚¨åˆ°ES

#### 2. è®¢å•äº‹ä»¶å¤„ç†æµç¨‹

```
RocketMQè®¢å•äº‹ä»¶ -> OrderEventConsumer -> OrderEventProcessor -> Elasticsearch
                       â†“
                   å¹‚ç­‰æ£€æŸ¥ -> æ•°æ®è„±æ• -> æ–‡æ¡£æ„å»º -> ESå­˜å‚¨
```

### æ ¸å¿ƒç»„ä»¶

#### 1. è®¢å•äº‹ä»¶æ¶ˆè´¹è€… (OrderEventConsumer)

```java
@Component
public class OrderEventConsumer {
    @Bean
    public Consumer<Message<OrderChangeEvent>> orderConsumer() {
        return message -> {
            // è·å–æ¶ˆæ¯å†…å®¹å’Œå¤´ä¿¡æ¯
            OrderChangeEvent event = message.getPayload();
            String traceId = (String) message.getHeaders().get("traceId");
            String eventType = (String) message.getHeaders().get("eventType");
            
            // å¤„ç†è®¢å•äº‹ä»¶
            orderEventProcessor.processOrderEvent(event, message.getHeaders());
        };
    }
}
```

**ç‰¹ç‚¹**:

- ä½¿ç”¨å®˜æ–¹æ ‡å‡†çš„å‡½æ•°å¼ç¼–ç¨‹æ¨¡å‹
- è‡ªåŠ¨æ¶ˆæ¯ç¡®è®¤å’Œå¼‚å¸¸å¤„ç†
- å®Œæ•´çš„æ¶ˆæ¯å¤´è§£æå’Œæ—¥å¿—è®°å½•

#### 2. è®¢å•äº‹ä»¶å¤„ç†å™¨ (OrderEventProcessor)

```java
@Component
public class OrderEventProcessor {
    public void processOrderEvent(OrderChangeEvent event, MessageHeaders headers) {
        // å¹‚ç­‰æ€§æ£€æŸ¥
        if (orderEventService.existsByOrderIdAndEventType(event.getOrderId(), eventType, traceId)) {
            return;
        }
        
        // æ„å»ºESæ–‡æ¡£
        OrderEventDocument document = buildOrderEventDocument(event, headers);
        
        // æ•æ„Ÿä¿¡æ¯è„±æ•
        sanitizeSensitiveData(document);
        
        // ä¿å­˜åˆ°Elasticsearch
        orderEventService.saveOrderEvent(document);
    }
}
```

**åŠŸèƒ½**:

- **å¹‚ç­‰æ€§ä¿è¯**: åŸºäºTraceIdé˜²æ­¢é‡å¤å¤„ç†
- **æ•°æ®è½¬æ¢**: å°†äº‹ä»¶å¯¹è±¡è½¬æ¢ä¸ºESæ–‡æ¡£æ ¼å¼
- **æ•æ„Ÿæ•°æ®è„±æ•**: è‡ªåŠ¨å¤„ç†æ‰‹æœºå·ã€åœ°å€ç­‰æ•æ„Ÿä¿¡æ¯
- **å¼‚å¸¸å¤„ç†**: å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

#### 3. è®¢å•äº‹ä»¶ESæ–‡æ¡£æ¨¡å‹ (OrderEventDocument)

```java
@Document(indexName = "order-events", createIndex = true)
@Data
@Builder
public class OrderEventDocument {
    @Id
    private String id;
    
    @Field(type = FieldType.Long)
    private Long orderId;
    
    @Field(type = FieldType.Keyword)
    private String eventType;
    
    @Field(type = FieldType.Keyword)
    private String traceId;
    
    // ... å…¶ä»–è®¢å•ç›¸å…³å­—æ®µ
}
```

**ç´¢å¼•è®¾è®¡**:

- **ç´¢å¼•åç§°**: `order-events`
- **æ–‡æ¡£ID**: `order_{orderId}_{eventType}_{traceId}_{timestamp}`
- **å­—æ®µç±»å‹**: æ ¹æ®æŸ¥è¯¢éœ€æ±‚ä¼˜åŒ–å­—æ®µç±»å‹

### æ•°æ®è„±æ•ç­–ç•¥

#### 1. æ•æ„Ÿä¿¡æ¯è¯†åˆ«

- **æ‰‹æœºå·è„±æ•**: ä¿ç•™å‰3ä½å’Œå4ä½ (`138****5678`)
- **æ”¶è´§åœ°å€è„±æ•**: åªä¿ç•™çœå¸‚ä¿¡æ¯ï¼Œè¯¦ç»†åœ°å€ç”¨`****`æ›¿ä»£
- **æ”¶è´§äººå§“åè„±æ•**: åªæ˜¾ç¤ºå§“æ°ï¼Œå…¶ä½™ç”¨`**`æ›¿ä»£ (`å¼ **`)

#### 2. è„±æ•å®ç°

```java
private void sanitizeSensitiveData(OrderEventDocument document) {
    // æ‰‹æœºå·è„±æ•
    if (StringUtils.hasText(document.getReceiverPhone()) && document.getReceiverPhone().length() >= 7) {
        String phone = document.getReceiverPhone();
        String masked = phone.substring(0, 3) + "****" + phone.substring(phone.length() - 4);
        document.setReceiverPhone(masked);
    }
    
    // åœ°å€è„±æ•
    if (StringUtils.hasText(document.getReceiverAddress())) {
        String address = document.getReceiverAddress();
        if (address.length() > 10) {
            document.setReceiverAddress(address.substring(0, Math.min(10, address.length())) + "****");
        }
    }
}
```

### æœåŠ¡å±‚è®¾è®¡

#### 1. OrderEventServiceæ¥å£

```java
public interface OrderEventService {
    // ä¿å­˜è®¢å•äº‹ä»¶
    void saveOrderEvent(OrderEventDocument document);
    
    // å¹‚ç­‰æ€§æ£€æŸ¥
    boolean existsByOrderIdAndEventType(Long orderId, String eventType, String traceId);
    
    // æŸ¥è¯¢åŠŸèƒ½
    List<OrderEventDocument> findByOrderId(Long orderId);
    Page<OrderEventDocument> findByUserId(Long userId, Pageable pageable);
    Page<OrderEventDocument> findByEventType(String eventType, Pageable pageable);
    
    // ç»Ÿè®¡åŠŸèƒ½
    long countByEventTimeBetween(LocalDateTime startTime, LocalDateTime endTime);
    long countByUserId(Long userId);
    
    // æ•°æ®æ¸…ç†
    void deleteExpiredEvents(LocalDateTime expiredTime);
}
```

#### 2. Repositoryå±‚

```java
@Repository
public interface OrderEventRepository extends ElasticsearchRepository<OrderEventDocument, String> {
    // æŒ‰è®¢å•IDæŸ¥è¯¢ï¼ˆæŒ‰æ—¶é—´å€’åºï¼‰
    List<OrderEventDocument> findByOrderIdOrderByEventTimeDesc(Long orderId);
    
    // æŒ‰ç”¨æˆ·IDåˆ†é¡µæŸ¥è¯¢
    Page<OrderEventDocument> findByUserIdOrderByEventTimeDesc(Long userId, Pageable pageable);
    
    // æŒ‰äº‹ä»¶ç±»å‹æŸ¥è¯¢
    Page<OrderEventDocument> findByEventTypeOrderByEventTimeDesc(String eventType, Pageable pageable);
    
    // æ—¶é—´èŒƒå›´æŸ¥è¯¢
    Page<OrderEventDocument> findByEventTimeBetweenOrderByEventTimeDesc(
        LocalDateTime startTime, LocalDateTime endTime, Pageable pageable);
    
    // å¹‚ç­‰æ€§æ£€æŸ¥
    boolean existsByTraceId(String traceId);
    boolean existsByOrderIdAndEventType(Long orderId, String eventType);
    
    // ç»Ÿè®¡æŸ¥è¯¢
    long countByEventTimeBetween(LocalDateTime startTime, LocalDateTime endTime);
    long countByUserId(Long userId);
    
    // æ•°æ®æ¸…ç†
    long deleteByEventTimeBefore(LocalDateTime expiredTime);
}
```

### é…ç½®ç®¡ç†

#### 1. RocketMQæ¶ˆè´¹è€…é…ç½® (application-order.yml)

```yaml
spring:
  cloud:
    stream:
      function:
        definition: orderConsumer
      bindings:
        orderConsumer-in-0:
          destination: order-events
          content-type: application/json
          group: log-service-order-group
          consumer:
            maxAttempts: 3
            backOffInitialInterval: 1000
            backOffMaxInterval: 10000
      rocketmq:
        bindings:
          orderConsumer-in-0:
            consumer:
              subscription: 'order-created||order-paid||order-shipped||order-completed||order-cancelled||order-refunded||order-status-changed||order-timeout'
              messageModel: CLUSTERING
              consumeThreadMin: 5
              consumeThreadMax: 20
              pullBatchSize: 16
              consumeTimeout: 10000
```

**é…ç½®è¯´æ˜**:

- **æ¶ˆè´¹ç»„**: `log-service-order-group` ç¡®ä¿æ¶ˆæ¯ä¸è¢«é‡å¤æ¶ˆè´¹
- **è®¢é˜…æ ‡ç­¾**: æ”¯æŒæ‰€æœ‰è®¢å•äº‹ä»¶ç±»å‹çš„æ¶ˆæ¯
- **æ¶ˆè´¹æ¨¡å¼**: é›†ç¾¤æ¶ˆè´¹ï¼Œæ”¯æŒæ°´å¹³æ‰©å±•
- **é‡è¯•æœºåˆ¶**: æ”¯æŒæ¶ˆæ¯é‡è¯•å’ŒæŒ‡æ•°é€€é¿

#### 2. Elasticsearché…ç½®

```yaml
spring:
  elasticsearch:
    uris: http://localhost:9200
    username: elastic
    password: your_password
    connection-timeout: 10s
    socket-timeout: 30s
```

### æŸ¥è¯¢å’Œåˆ†æåŠŸèƒ½

#### 1. è®¢å•äº‹ä»¶æŸ¥è¯¢API

- **æŒ‰è®¢å•IDæŸ¥è¯¢**: `/api/order-events/order/{orderId}`
- **æŒ‰ç”¨æˆ·IDæŸ¥è¯¢**: `/api/order-events/user/{userId}`
- **æŒ‰äº‹ä»¶ç±»å‹æŸ¥è¯¢**: `/api/order-events/type/{eventType}`
- **æŒ‰æ—¶é—´èŒƒå›´æŸ¥è¯¢**: `/api/order-events/range?start={startTime}&end={endTime}`

#### 2. ç»Ÿè®¡åˆ†æåŠŸèƒ½

- **äº‹ä»¶æ•°é‡ç»Ÿè®¡**: æŒ‰æ—¶é—´æ®µã€ç”¨æˆ·ã€äº‹ä»¶ç±»å‹ç»Ÿè®¡
- **è®¢å•ç”Ÿå‘½å‘¨æœŸåˆ†æ**: è¿½è¸ªå•ä¸ªè®¢å•çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸ
- **ç”¨æˆ·è¡Œä¸ºåˆ†æ**: åˆ†æç”¨æˆ·çš„è®¢å•æ“ä½œæ¨¡å¼

### ç›‘æ§å’Œè¿ç»´

#### 1. æ¶ˆè´¹ç›‘æ§æŒ‡æ ‡

- æ¶ˆæ¯æ¶ˆè´¹é€Ÿåº¦ï¼ˆTPSï¼‰
- æ¶ˆè´¹å»¶è¿Ÿæ—¶é—´
- æ¶ˆè´¹æˆåŠŸç‡
- å¼‚å¸¸æ¶ˆæ¯æ•°é‡

#### 2. ESå­˜å‚¨ç›‘æ§

- æ–‡æ¡£å†™å…¥é€Ÿåº¦
- ç´¢å¼•å¤§å°å’Œæ–‡æ¡£æ•°é‡
- æŸ¥è¯¢å“åº”æ—¶é—´
- å­˜å‚¨ç©ºé—´ä½¿ç”¨ç‡

#### 3. æ—¥å¿—è§„èŒƒ

```
# æ¶ˆæ¯æ¥æ”¶æ—¥å¿—
ğŸ”” æ¥æ”¶åˆ°è®¢å•äº‹ä»¶ - äº‹ä»¶ç±»å‹: ORDER_CREATED, è®¢å•ID: 123456, ç”¨æˆ·ID: 789, TraceId: abc123

# å¤„ç†æˆåŠŸæ—¥å¿—  
âœ… è®¢å•äº‹ä»¶å¤„ç†å®Œæˆ - è®¢å•ID: 123456, äº‹ä»¶ç±»å‹: ORDER_CREATED, TraceId: abc123

# å­˜å‚¨æˆåŠŸæ—¥å¿—
ğŸ“ è®¢å•äº‹ä»¶å·²å­˜å‚¨åˆ°ES - è®¢å•ID: 123456, äº‹ä»¶ç±»å‹: ORDER_CREATED, æ–‡æ¡£ID: order_123456_ORDER_CREATED_abc123_1642234567890

# å¼‚å¸¸æ—¥å¿—
âŒ å¤„ç†è®¢å•äº‹ä»¶æ—¶å‘ç”Ÿå¼‚å¸¸: è¿æ¥è¶…æ—¶, TraceId: abc123
```

### å¼‚å¸¸å¤„ç†ç­–ç•¥

#### 1. æ¶ˆæ¯æ¶ˆè´¹å¼‚å¸¸

- **é‡è¯•æœºåˆ¶**: æŒ‡æ•°é€€é¿é‡è¯•ï¼Œæœ€å¤§3æ¬¡
- **æ­»ä¿¡é˜Ÿåˆ—**: é‡è¯•å¤±è´¥åå‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—
- **äººå·¥ä»‹å…¥**: æ­»ä¿¡æ¶ˆæ¯éœ€è¦äººå·¥æ’æŸ¥å’Œå¤„ç†

#### 2. ESå­˜å‚¨å¼‚å¸¸

- **è¿æ¥é‡è¯•**: è‡ªåŠ¨é‡è¯•è¿æ¥
- **é™çº§å¤„ç†**: ESä¸å¯ç”¨æ—¶æš‚æ—¶å­˜å‚¨åˆ°æ–‡ä»¶
- **æ•°æ®æ¢å¤**: æ”¯æŒä»å¤‡ä»½æ•°æ®æ¢å¤

### æ€§èƒ½ä¼˜åŒ–

#### 1. æ¶ˆè´¹æ€§èƒ½ä¼˜åŒ–

- **å¹¶è¡Œæ¶ˆè´¹**: é…ç½®å¤šä¸ªæ¶ˆè´¹çº¿ç¨‹
- **æ‰¹é‡å¤„ç†**: æ‰¹é‡å†™å…¥ESæé«˜æ€§èƒ½
- **èµ„æºæ± åŒ–**: å¤ç”¨è¿æ¥å’Œçº¿ç¨‹èµ„æº

#### 2. ESå­˜å‚¨ä¼˜åŒ–

- **ç´¢å¼•æ¨¡æ¿**: é¢„å®šä¹‰ç´¢å¼•æ˜ å°„å’Œé…ç½®
- **æ‰¹é‡å†™å…¥**: ä½¿ç”¨æ‰¹é‡APIæé«˜å†™å…¥æ€§èƒ½
- **ç´¢å¼•åˆ†ç‰‡**: åˆç†è®¾ç½®åˆ†ç‰‡æ•°é‡
- **å®šæœŸæ¸…ç†**: å®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®

## æ”¯ä»˜äº‹ä»¶æ¶ˆè´¹ç³»ç»Ÿ

### ç³»ç»Ÿæ¶æ„

#### 1. æ”¯ä»˜äº‹ä»¶å¤„ç†æµç¨‹

```
RocketMQæ”¯ä»˜äº‹ä»¶ -> PaymentEventConsumer -> PaymentEventProcessor -> Elasticsearch
                       â†“
                   å¹‚ç­‰æ£€æŸ¥ -> æ•°æ®è„±æ• -> æ–‡æ¡£æ„å»º -> ESå­˜å‚¨
```

#### 2. æ”¯æŒçš„æ”¯ä»˜äº‹ä»¶ç±»å‹

| äº‹ä»¶ç±»å‹                   | Tagæ ‡ç­¾                  | ä¸šåŠ¡åœºæ™¯  |
|------------------------|------------------------|-------|
| PAYMENT_CREATED        | payment-created        | æ”¯ä»˜åˆ›å»º  |
| PAYMENT_PROCESSING     | payment-processing     | æ”¯ä»˜å¤„ç†ä¸­ |
| PAYMENT_SUCCESS        | payment-success        | æ”¯ä»˜æˆåŠŸ  |
| PAYMENT_FAILED         | payment-failed         | æ”¯ä»˜å¤±è´¥  |
| PAYMENT_TIMEOUT        | payment-timeout        | æ”¯ä»˜è¶…æ—¶  |
| REFUND_APPLIED         | refund-applied         | é€€æ¬¾ç”³è¯·  |
| REFUND_SUCCESS         | refund-success         | é€€æ¬¾æˆåŠŸ  |
| REFUND_FAILED          | refund-failed          | é€€æ¬¾å¤±è´¥  |
| PAYMENT_STATUS_CHANGED | payment-status-changed | çŠ¶æ€å˜æ›´  |
| PAYMENT_CALLBACK       | payment-callback       | æ”¯ä»˜å›è°ƒ  |

#### 3. æ”¯ä»˜äº‹ä»¶æ•°æ®è„±æ•ç­–ç•¥

- **æ”¯ä»˜å•å·è„±æ•**: åªä¿ç•™å‰4ä½å’Œå4ä½
- **IPåœ°å€è„±æ•**: åªä¿ç•™å‰ä¸‰æ®µ
- **è®¾å¤‡ä¿¡æ¯è„±æ•**: æˆªæ–­è¯¦ç»†æ ‡è¯†ä¿¡æ¯
- **URLè„±æ•**: åªä¿ç•™åŸŸåéƒ¨åˆ†

## ç”¨æˆ·äº‹ä»¶æ¶ˆè´¹ç³»ç»Ÿ

### ç³»ç»Ÿæ¶æ„

#### 1. ç”¨æˆ·äº‹ä»¶å¤„ç†æµç¨‹

```
RocketMQç”¨æˆ·äº‹ä»¶ -> UserEventConsumer -> UserEventProcessor -> Elasticsearch
                       â†“
                   å¹‚ç­‰æ£€æŸ¥ -> æ•°æ®è„±æ• -> æ–‡æ¡£æ„å»º -> ESå­˜å‚¨
```

#### 2. æ”¯æŒçš„ç”¨æˆ·äº‹ä»¶ç±»å‹

| äº‹ä»¶ç±»å‹                | Tagæ ‡ç­¾               | ä¸šåŠ¡åœºæ™¯   |
|---------------------|---------------------|--------|
| USER_REGISTERED     | user-registered     | ç”¨æˆ·æ³¨å†Œ   |
| USER_LOGIN          | user-login          | ç”¨æˆ·ç™»å½•   |
| USER_LOGOUT         | user-logout         | ç”¨æˆ·ç™»å‡º   |
| USER_UPDATED        | user-updated        | ç”¨æˆ·ä¿¡æ¯æ›´æ–° |
| PASSWORD_CHANGED    | password-changed    | å¯†ç ä¿®æ”¹   |
| USER_STATUS_CHANGED | user-status-changed | ç”¨æˆ·çŠ¶æ€å˜æ›´ |
| USER_VERIFICATION   | user-verification   | å®åè®¤è¯   |
| AVATAR_UPDATED      | avatar-updated      | å¤´åƒæ›´æ–°   |
| PHONE_BIND          | phone-bind          | ç»‘å®šæ‰‹æœº   |
| EMAIL_BIND          | email-bind          | ç»‘å®šé‚®ç®±   |
| USER_DELETED        | user-deleted        | ç”¨æˆ·æ³¨é”€   |

#### 3. ç”¨æˆ·äº‹ä»¶æ•°æ®è„±æ•ç­–ç•¥

- **é‚®ç®±è„±æ•**: åªä¿ç•™å‰3ä½å’Œ@åçš„åŸŸå (`abc****@domain.com`)
- **æ‰‹æœºå·è„±æ•**: ä¿ç•™å‰3ä½å’Œå4ä½ (`138****5678`)
- **çœŸå®å§“åè„±æ•**: åªæ˜¾ç¤ºå§“æ° (`å¼ **`)
- **èº«ä»½è¯å·è„±æ•**: åªä¿ç•™å‰4ä½å’Œå4ä½ (`1234**********5678`)
- **åœ°å€è„±æ•**: åªä¿ç•™çœå¸‚ä¿¡æ¯
- **IPåœ°å€è„±æ•**: åªä¿ç•™å‰ä¸‰æ®µ (`192.168.1.***`)

## å¤šäº‹ä»¶ç³»ç»Ÿé›†æˆæ¶æ„

### æ•´ä½“æ¶ˆæ¯æµæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Order Service â”‚    â”‚  Payment Service â”‚    â”‚   User Service  â”‚
â”‚                 â”‚    â”‚                  â”‚    â”‚                 â”‚
â”‚ OrderEventProducer  â”‚ PaymentEventProducer â”‚ â”‚ UserEventProducer â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                     â”‚                        â”‚
          â”‚                     â”‚                        â”‚
          â–¼                     â–¼                        â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                      RocketMQ                               â”‚
    â”‚  order-events     payment-events     user-events          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                   Log Service                              â”‚
    â”‚  OrderEventConsumer  PaymentEventConsumer  UserEventConsumerâ”‚
    â”‚         â”‚                    â”‚                    â”‚         â”‚
    â”‚  OrderEventProcessor PaymentEventProcessor UserEventProcessorâ”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                  â”‚                  â”‚
              â–¼                  â–¼                  â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                   Elasticsearch                            â”‚
    â”‚   order-events     payment-events     user-events         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¶ˆè´¹è€…å‡½æ•°é…ç½®

```yaml
spring:
  cloud:
    stream:
      function:
        definition: orderConsumer,paymentConsumer,userConsumer
```

## æœåŠ¡é…ç½®

### æœåŠ¡åŸºæœ¬ä¿¡æ¯

- **æœåŠ¡åç§°**: log-service
- **è¿è¡Œç«¯å£**: 8087
- **è®¤è¯æ–¹å¼**: OAuth2.1 JWT (é€šè¿‡ç½‘å…³è®¿é—® JWK ç«¯ç‚¹)
- **ç¼“å­˜æ—¶é—´**: 30åˆ†é’Ÿ

### å…³é”®é…ç½®

```yaml
server:
  port: 8087

spring:
  application:
    name: log-service
  security:
    oauth2:
      resourceserver:
        jwt:
          jwk-set-uri: http://127.0.0.1:80/.well-known/jwks.json
          cache-duration: PT30M
  data:
    redis:
      host: localhost
      port: 6379
      password: root
      database: 0
    elasticsearch:
      repositories:
        enabled: true
elasticsearch:
  url: http://localhost:9201
```

### RocketMQ é…ç½®æ›´æ–°

å®é™…é…ç½®ä¸­ NameServer ç«¯å£ä¸º 39876ï¼Œä¸æ˜¯ 9876ã€‚å¹¶ä¸”æ”¯æŒå¤šä¸ªæ—¥å¿— Topicã€‚

---

**æ›´æ–°æ—¶é—´**: 2025/9/23  
**ç‰ˆæœ¬**: v2.1.0  
**æ›´æ–°å†…å®¹**: æ›´æ–°ä¾èµ–ç‰ˆæœ¬ä¸º Spring Boot 3.5.3ã€Spring Cloud 2025.0.0ï¼Œæ›´æ–°å®é™…é…ç½®ä¿¡æ¯

**ä¸Šä¸€ç‰ˆæœ¬**:  
**æ›´æ–°æ—¶é—´**: 2025/1/15  
**ç‰ˆæœ¬**: v2.0.0  
**æ›´æ–°å†…å®¹**: æ–°å¢è®¢å•ã€æ”¯ä»˜ã€ç”¨æˆ·ä¸‰å¤§äº‹ä»¶æ¶ˆè´¹ç³»ç»Ÿå®Œæ•´æ¶æ„å’Œå®ç°
