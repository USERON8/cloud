# 日志服务开发文档

## 项目概述

日志服务负责消费各个业务服务产生的事件消息，进行数据处理、脱敏、转换后存储到Elasticsearch，为系统提供统一的日志查询、分析和监控能力。

## 技术栈

### 核心框架

- **Spring Boot**: 3.5.3
- **Spring Cloud**: 2025.0.0
- **Spring Cloud Alibaba**: 2025.0.0.0-preview
- **Spring Cloud Stream**: RocketMQ Binder
- **Java版本**: 17 LTS

### 依赖版本

```xml
<spring-boot.version>3.5.3</spring-boot.version>
<spring-cloud.version>2025.0.0</spring-cloud.version>
<spring-cloud-alibaba.version>2025.0.0.0-preview</spring-cloud-alibaba.version>
<java.version>17</java.version>
```

### 数据存储

- **Elasticsearch**: 8.x+ (日志事件存储和搜索，端口: 9201)
- **RocketMQ**: 5.3.2 (消息队列，端口: 39876)
- **Redis**: 7.0+ (缓存，数据库0)

## 订单事件消费系统

### 系统架构

#### 1. 消息消费架构

基于阿里巴巴Spring Cloud Alibaba官方示例标准实现：

- **消息消费者**: 使用函数式编程模型消费RocketMQ消息
- **事件处理器**: 处理业务逻辑、数据转换和脱敏
- **数据存储层**: 基于Spring Data Elasticsearch存储到ES

#### 2. 订单事件处理流程

```
RocketMQ订单事件 -> OrderEventConsumer -> OrderEventProcessor -> Elasticsearch
                       ↓
                   幂等检查 -> 数据脱敏 -> 文档构建 -> ES存储
```

### 核心组件

#### 1. 订单事件消费者 (OrderEventConsumer)

```java
@Component
public class OrderEventConsumer {
    @Bean
    public Consumer<Message<OrderChangeEvent>> orderConsumer() {
        return message -> {
            // 获取消息内容和头信息
            OrderChangeEvent event = message.getPayload();
            String traceId = (String) message.getHeaders().get("traceId");
            String eventType = (String) message.getHeaders().get("eventType");
            
            // 处理订单事件
            orderEventProcessor.processOrderEvent(event, message.getHeaders());
        };
    }
}
```

**特点**:

- 使用官方标准的函数式编程模型
- 自动消息确认和异常处理
- 完整的消息头解析和日志记录

#### 2. 订单事件处理器 (OrderEventProcessor)

```java
@Component
public class OrderEventProcessor {
    public void processOrderEvent(OrderChangeEvent event, MessageHeaders headers) {
        // 幂等性检查
        if (orderEventService.existsByOrderIdAndEventType(event.getOrderId(), eventType, traceId)) {
            return;
        }
        
        // 构建ES文档
        OrderEventDocument document = buildOrderEventDocument(event, headers);
        
        // 敏感信息脱敏
        sanitizeSensitiveData(document);
        
        // 保存到Elasticsearch
        orderEventService.saveOrderEvent(document);
    }
}
```

**功能**:

- **幂等性保证**: 基于TraceId防止重复处理
- **数据转换**: 将事件对象转换为ES文档格式
- **敏感数据脱敏**: 自动处理手机号、地址等敏感信息
- **异常处理**: 完整的错误处理和日志记录

#### 3. 订单事件ES文档模型 (OrderEventDocument)

```java
@Document(indexName = "order-events", createIndex = true)
@Data
@Builder
public class OrderEventDocument {
    @Id
    private String id;
    
    @Field(type = FieldType.Long)
    private Long orderId;
    
    @Field(type = FieldType.Keyword)
    private String eventType;
    
    @Field(type = FieldType.Keyword)
    private String traceId;
    
    // ... 其他订单相关字段
}
```

**索引设计**:

- **索引名称**: `order-events`
- **文档ID**: `order_{orderId}_{eventType}_{traceId}_{timestamp}`
- **字段类型**: 根据查询需求优化字段类型

### 数据脱敏策略

#### 1. 敏感信息识别

- **手机号脱敏**: 保留前3位和后4位 (`138****5678`)
- **收货地址脱敏**: 只保留省市信息，详细地址用`****`替代
- **收货人姓名脱敏**: 只显示姓氏，其余用`**`替代 (`张**`)

#### 2. 脱敏实现

```java
private void sanitizeSensitiveData(OrderEventDocument document) {
    // 手机号脱敏
    if (StringUtils.hasText(document.getReceiverPhone()) && document.getReceiverPhone().length() >= 7) {
        String phone = document.getReceiverPhone();
        String masked = phone.substring(0, 3) + "****" + phone.substring(phone.length() - 4);
        document.setReceiverPhone(masked);
    }
    
    // 地址脱敏
    if (StringUtils.hasText(document.getReceiverAddress())) {
        String address = document.getReceiverAddress();
        if (address.length() > 10) {
            document.setReceiverAddress(address.substring(0, Math.min(10, address.length())) + "****");
        }
    }
}
```

### 服务层设计

#### 1. OrderEventService接口

```java
public interface OrderEventService {
    // 保存订单事件
    void saveOrderEvent(OrderEventDocument document);
    
    // 幂等性检查
    boolean existsByOrderIdAndEventType(Long orderId, String eventType, String traceId);
    
    // 查询功能
    List<OrderEventDocument> findByOrderId(Long orderId);
    Page<OrderEventDocument> findByUserId(Long userId, Pageable pageable);
    Page<OrderEventDocument> findByEventType(String eventType, Pageable pageable);
    
    // 统计功能
    long countByEventTimeBetween(LocalDateTime startTime, LocalDateTime endTime);
    long countByUserId(Long userId);
    
    // 数据清理
    void deleteExpiredEvents(LocalDateTime expiredTime);
}
```

#### 2. Repository层

```java
@Repository
public interface OrderEventRepository extends ElasticsearchRepository<OrderEventDocument, String> {
    // 按订单ID查询（按时间倒序）
    List<OrderEventDocument> findByOrderIdOrderByEventTimeDesc(Long orderId);
    
    // 按用户ID分页查询
    Page<OrderEventDocument> findByUserIdOrderByEventTimeDesc(Long userId, Pageable pageable);
    
    // 按事件类型查询
    Page<OrderEventDocument> findByEventTypeOrderByEventTimeDesc(String eventType, Pageable pageable);
    
    // 时间范围查询
    Page<OrderEventDocument> findByEventTimeBetweenOrderByEventTimeDesc(
        LocalDateTime startTime, LocalDateTime endTime, Pageable pageable);
    
    // 幂等性检查
    boolean existsByTraceId(String traceId);
    boolean existsByOrderIdAndEventType(Long orderId, String eventType);
    
    // 统计查询
    long countByEventTimeBetween(LocalDateTime startTime, LocalDateTime endTime);
    long countByUserId(Long userId);
    
    // 数据清理
    long deleteByEventTimeBefore(LocalDateTime expiredTime);
}
```

### 配置管理

#### 1. RocketMQ消费者配置 (application-order.yml)

```yaml
spring:
  cloud:
    stream:
      function:
        definition: orderConsumer
      bindings:
        orderConsumer-in-0:
          destination: order-events
          content-type: application/json
          group: log-service-order-group
          consumer:
            maxAttempts: 3
            backOffInitialInterval: 1000
            backOffMaxInterval: 10000
      rocketmq:
        bindings:
          orderConsumer-in-0:
            consumer:
              subscription: 'order-created||order-paid||order-shipped||order-completed||order-cancelled||order-refunded||order-status-changed||order-timeout'
              messageModel: CLUSTERING
              consumeThreadMin: 5
              consumeThreadMax: 20
              pullBatchSize: 16
              consumeTimeout: 10000
```

**配置说明**:

- **消费组**: `log-service-order-group` 确保消息不被重复消费
- **订阅标签**: 支持所有订单事件类型的消息
- **消费模式**: 集群消费，支持水平扩展
- **重试机制**: 支持消息重试和指数退避

#### 2. Elasticsearch配置

```yaml
spring:
  elasticsearch:
    uris: http://localhost:9200
    username: elastic
    password: your_password
    connection-timeout: 10s
    socket-timeout: 30s
```

### 查询和分析功能

#### 1. 订单事件查询API

- **按订单ID查询**: `/api/order-events/order/{orderId}`
- **按用户ID查询**: `/api/order-events/user/{userId}`
- **按事件类型查询**: `/api/order-events/type/{eventType}`
- **按时间范围查询**: `/api/order-events/range?start={startTime}&end={endTime}`

#### 2. 统计分析功能

- **事件数量统计**: 按时间段、用户、事件类型统计
- **订单生命周期分析**: 追踪单个订单的完整生命周期
- **用户行为分析**: 分析用户的订单操作模式

### 监控和运维

#### 1. 消费监控指标

- 消息消费速度（TPS）
- 消费延迟时间
- 消费成功率
- 异常消息数量

#### 2. ES存储监控

- 文档写入速度
- 索引大小和文档数量
- 查询响应时间
- 存储空间使用率

#### 3. 日志规范

```
# 消息接收日志
🔔 接收到订单事件 - 事件类型: ORDER_CREATED, 订单ID: 123456, 用户ID: 789, TraceId: abc123

# 处理成功日志  
✅ 订单事件处理完成 - 订单ID: 123456, 事件类型: ORDER_CREATED, TraceId: abc123

# 存储成功日志
📁 订单事件已存储到ES - 订单ID: 123456, 事件类型: ORDER_CREATED, 文档ID: order_123456_ORDER_CREATED_abc123_1642234567890

# 异常日志
❌ 处理订单事件时发生异常: 连接超时, TraceId: abc123
```

### 异常处理策略

#### 1. 消息消费异常

- **重试机制**: 指数退避重试，最大3次
- **死信队列**: 重试失败后发送到死信队列
- **人工介入**: 死信消息需要人工排查和处理

#### 2. ES存储异常

- **连接重试**: 自动重试连接
- **降级处理**: ES不可用时暂时存储到文件
- **数据恢复**: 支持从备份数据恢复

### 性能优化

#### 1. 消费性能优化

- **并行消费**: 配置多个消费线程
- **批量处理**: 批量写入ES提高性能
- **资源池化**: 复用连接和线程资源

#### 2. ES存储优化

- **索引模板**: 预定义索引映射和配置
- **批量写入**: 使用批量API提高写入性能
- **索引分片**: 合理设置分片数量
- **定期清理**: 定期清理过期数据

## 支付事件消费系统

### 系统架构

#### 1. 支付事件处理流程

```
RocketMQ支付事件 -> PaymentEventConsumer -> PaymentEventProcessor -> Elasticsearch
                       ↓
                   幂等检查 -> 数据脱敏 -> 文档构建 -> ES存储
```

#### 2. 支持的支付事件类型

| 事件类型                   | Tag标签                  | 业务场景  |
|------------------------|------------------------|-------|
| PAYMENT_CREATED        | payment-created        | 支付创建  |
| PAYMENT_PROCESSING     | payment-processing     | 支付处理中 |
| PAYMENT_SUCCESS        | payment-success        | 支付成功  |
| PAYMENT_FAILED         | payment-failed         | 支付失败  |
| PAYMENT_TIMEOUT        | payment-timeout        | 支付超时  |
| REFUND_APPLIED         | refund-applied         | 退款申请  |
| REFUND_SUCCESS         | refund-success         | 退款成功  |
| REFUND_FAILED          | refund-failed          | 退款失败  |
| PAYMENT_STATUS_CHANGED | payment-status-changed | 状态变更  |
| PAYMENT_CALLBACK       | payment-callback       | 支付回调  |

#### 3. 支付事件数据脱敏策略

- **支付单号脱敏**: 只保留前4位和后4位
- **IP地址脱敏**: 只保留前三段
- **设备信息脱敏**: 截断详细标识信息
- **URL脱敏**: 只保留域名部分

## 用户事件消费系统

### 系统架构

#### 1. 用户事件处理流程

```
RocketMQ用户事件 -> UserEventConsumer -> UserEventProcessor -> Elasticsearch
                       ↓
                   幂等检查 -> 数据脱敏 -> 文档构建 -> ES存储
```

#### 2. 支持的用户事件类型

| 事件类型                | Tag标签               | 业务场景   |
|---------------------|---------------------|--------|
| USER_REGISTERED     | user-registered     | 用户注册   |
| USER_LOGIN          | user-login          | 用户登录   |
| USER_LOGOUT         | user-logout         | 用户登出   |
| USER_UPDATED        | user-updated        | 用户信息更新 |
| PASSWORD_CHANGED    | password-changed    | 密码修改   |
| USER_STATUS_CHANGED | user-status-changed | 用户状态变更 |
| USER_VERIFICATION   | user-verification   | 实名认证   |
| AVATAR_UPDATED      | avatar-updated      | 头像更新   |
| PHONE_BIND          | phone-bind          | 绑定手机   |
| EMAIL_BIND          | email-bind          | 绑定邮箱   |
| USER_DELETED        | user-deleted        | 用户注销   |

#### 3. 用户事件数据脱敏策略

- **邮箱脱敏**: 只保留前3位和@后的域名 (`abc****@domain.com`)
- **手机号脱敏**: 保留前3位和后4位 (`138****5678`)
- **真实姓名脱敏**: 只显示姓氏 (`张**`)
- **身份证号脱敏**: 只保留前4位和后4位 (`1234**********5678`)
- **地址脱敏**: 只保留省市信息
- **IP地址脱敏**: 只保留前三段 (`192.168.1.***`)

## 多事件系统集成架构

### 整体消息流架构

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Order Service │    │  Payment Service │    │   User Service  │
│                 │    │                  │    │                 │
│ OrderEventProducer  │ PaymentEventProducer │ │ UserEventProducer │
└─────────┬───────┘    └────────┬─────────┘    └─────────┬───────┘
          │                     │                        │
          │                     │                        │
          ▼                     ▼                        ▼
    ┌─────────────────────────────────────────────────────────────┐
    │                      RocketMQ                               │
    │  order-events     payment-events     user-events          │
    └─────────────────────────┬───────────────────────────────────┘
                              │
                              ▼
    ┌─────────────────────────────────────────────────────────────┐
    │                   Log Service                              │
    │  OrderEventConsumer  PaymentEventConsumer  UserEventConsumer│
    │         │                    │                    │         │
    │  OrderEventProcessor PaymentEventProcessor UserEventProcessor│
    └─────────┬──────────────────┬──────────────────┬─────────────┘
              │                  │                  │
              ▼                  ▼                  ▼
    ┌─────────────────────────────────────────────────────────────┐
    │                   Elasticsearch                            │
    │   order-events     payment-events     user-events         │
    └─────────────────────────────────────────────────────────────┘
```

### 消费者函数配置

```yaml
spring:
  cloud:
    stream:
      function:
        definition: orderConsumer,paymentConsumer,userConsumer
```

## 服务配置

### 服务基本信息

- **服务名称**: log-service
- **运行端口**: 8087
- **认证方式**: OAuth2.1 JWT (通过网关访问 JWK 端点)
- **缓存时间**: 30分钟

### 关键配置

```yaml
server:
  port: 8087

spring:
  application:
    name: log-service
  security:
    oauth2:
      resourceserver:
        jwt:
          jwk-set-uri: http://127.0.0.1:80/.well-known/jwks.json
          cache-duration: PT30M
  data:
    redis:
      host: localhost
      port: 6379
      password: root
      database: 0
    elasticsearch:
      repositories:
        enabled: true
elasticsearch:
  url: http://localhost:9201
```

### RocketMQ 配置更新

实际配置中 NameServer 端口为 39876，不是 9876。并且支持多个日志 Topic。

---

**更新时间**: 2025/9/23  
**版本**: v2.1.0  
**更新内容**: 更新依赖版本为 Spring Boot 3.5.3、Spring Cloud 2025.0.0，更新实际配置信息

**上一版本**:  
**更新时间**: 2025/1/15  
**版本**: v2.0.0  
**更新内容**: 新增订单、支付、用户三大事件消费系统完整架构和实现
