services:
  # 兼容性注释已标准化。
  mysql:
    image: mysql:9.3.0
    container_name: cloud-mysql
    networks:
      service_net:
        ipv4_address: 172.28.0.10
    environment:
      MYSQL_ROOT_PASSWORD: "root"
      MYSQL_DATABASE: nacos_config
      MYSQL_USER: nacos
      MYSQL_PASSWORD: "nacos"
    volumes:
      - type: bind
        source: ./docker-compose/mysql/data
        target: /var/lib/mysql
      - type: bind
        source: ./docker-compose/mysql/config
        target: /etc/mysql/conf.d
      - type: bind
        source: ./docker-compose/mysql/logs
        target: /var/log/mysql
      - type: bind
        source: ./docker-compose/mysql/init
        target: /docker-entrypoint-initdb.d
    ports:
      - "${PORT_MYSQL:-13306}:3306"
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "127.0.0.1" ]
      interval: 5s
      timeout: 10s
      retries: 10

  # 兼容性注释已标准化。
  redis:
    image: redis:7.4.5-bookworm
    container_name: cloud-redis
    networks:
      service_net:
        ipv4_address: 172.28.0.20
    command: redis-server /usr/local/etc/redis/redis.conf --appendonly yes
    volumes:
      - type: bind
        source: ./docker-compose/redis/data
        target: /data
      - type: bind
        source: ./docker-compose/redis/conf
        target: /usr/local/etc/redis
      - type: bind
        source: ./docker-compose/redis/logs
        target: /var/log/redis
    ports:
      - "${PORT_REDIS:-16379}:6379"
    healthcheck:
      test: [ "CMD-SHELL", "redis-cli -a root ping | grep PONG" ]
      interval: 5s
      timeout: 5s
      retries: 5

  # 兼容性注释已标准化。
  nacos:
    image: nacos/nacos-server:v3.0.2
    container_name: cloud-nacos
    networks:
      service_net:
        ipv4_address: 172.28.0.30
    environment:
      MODE: standalone
      NACOS_SERVER_IP: 172.28.0.30

      SPRING_DATASOURCE_PLATFORM: mysql
      MYSQL_SERVICE_HOST: mysql
      MYSQL_SERVICE_PORT: 3306
      MYSQL_SERVICE_DB_NAME: nacos_config
      MYSQL_SERVICE_USER: nacos
      MYSQL_SERVICE_PASSWORD: nacos
      MYSQL_DATABASE_NUM: 1
      MYSQL_SERVICE_DB_PARAM: "characterEncoding=utf8&connectTimeout=1000&socketTimeout=3000&autoReconnect=true&useSSL=false"

      # 兼容性注释已标准化。
      NACOS_SERVER_CONTEXTPATH: /nacos  # 兼容性注释已标准化。
      NACOS_CONSOLE_CONTEXTPATH: /nacos  # 兼容性注释已标准化。
      NACOS_CONSOLE_REMOTE_SERVER_CONTEXT_PATH: /nacos  # 兼容性注释已标准化。

      # 兼容性注释已标准化。
      NACOS_AUTH_ENABLE: "true"  # 兼容性注释已标准化。
      NACOS_AUTH_IDENTITY_KEY: ServerIdentity_Key  # 兼容性注释已标准化。
      NACOS_AUTH_IDENTITY_VALUE: ServerIdentity_Value_123
      NACOS_AUTH_TOKEN: VGhpc0lzTXlDdXN0b21TZWNyZXRLZXkwMTIzNDU2Nzg=  # 兼容性注释已标准化。
      NACOS_SECURITY_IGNORE_URLS: "/,/error,/**/*.css,/**/*.js,/**/*.html,/**/*.map,/**/*.svg,/**/*.png,/**/*.ico,/console-ui/public/**,/v1/auth/**,/v1/console/health/**,/actuator/**,/v1/console/server/**"  # 兼容性注释已标准化。

      # 兼容性注释已标准化。
      NACOS_SECURITY_ADMIN_USER: root  # 兼容性注释已标准化。
      NACOS_SECURITY_ADMIN_PASSWORD: root

      # 兼容性注释已标准化。
      NACOS_CORE_AUTH_DEFAULT_ROLES: ADMIN
      NACOS_CORE_AUTH_DEFAULT_RESOURCE: "public:*:*"
      # 兼容性注释已标准化。
      JVM_XMS: 512m
      JVM_XMX: 512m
      NACOS_NAMING_EMPTY_SERVICE_AUTO_CLEAN: "true"

    ports:
      - "${PORT_NACOS_HTTP:-18848}:8848"
      - "${PORT_NACOS_GRPC:-19090}:9090"
      - "${PORT_NACOS_RAFT:-19848}:9848"
    volumes:
      - type: bind
        source: ./docker-compose/nacos/logs
        target: /home/nacos/logs
      - type: bind
        source: ./docker-compose/nacos/conf
        target: /home/nacos/conf
      - type: bind
        source: ./docker-compose/nacos/data
        target: /home/nacos/data
    depends_on:
      mysql:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://127.0.0.1:9090/nacos/" ]
      interval: 10s
      timeout: 5s
      retries: 12
  # 兼容性注释已标准化。
  namesrv:
    image: apache/rocketmq:5.3.2
    container_name: cloud-rmq-namesrv
    networks:
      service_net:
        ipv4_address: 172.28.0.40
    ports:
      - "${PORT_RMQ_NAMESRV:-19876}:9876"  # 兼容性注释已标准化。
    volumes:
      - type: bind
        source: ./docker-compose/rocketmq/namesrv/logs
        target: /home/rocketmq/namesrv/logs
      - type: bind
        source: ./docker-compose/rocketmq/namesrv/store
        target: /home/rocketmq/namesrv/store
    environment:
      - NAMESRV_ADDR=namesrv:9876
    command: sh mqnamesrv
  # 兼容性注释已标准化。
  broker:
    image: apache/rocketmq:5.3.2
    container_name: cloud-rmq-broker
    networks:
      service_net:
        ipv4_address: 172.28.0.50
    depends_on:
      - namesrv
    ports:
      - "${PORT_RMQ_BROKER_MAIN:-30909}:30909"  # 兼容性注释已标准化。
      - "${PORT_RMQ_BROKER_HA:-30911}:30911"  # 兼容性注释已标准化。
      - "${PORT_RMQ_BROKER_FAST_REPLY:-30912}:30912"  # 兼容性注释已标准化。
      - "${PORT_RMQ_PROXY_REMOTING:-38080}:8080"   # 兼容性注释已标准化。
      - "${PORT_RMQ_PROXY_HTTP2:-38081}:8081"   # 兼容性注释已标准化。
    volumes:
      - type: bind
        source: ./docker-compose/rocketmq/broker/logs
        target: /home/rocketmq/logs
      - type: bind
        source: ./docker-compose/rocketmq/broker/store
        target: /home/rocketmq/store
      - type: bind
        source: ./docker-compose/rocketmq/broker/conf
        target: /home/rocketmq/conf
    environment:
      - NAMESRV_ADDR=namesrv:9876
    # 兼容性注释已标准化。
    command: sh mqbroker -n namesrv:9876 --enable-proxy -c /home/rocketmq/conf/broker.conf

  # 兼容性注释已标准化。
  rmq-console:
    image: apacherocketmq/rocketmq-dashboard:2.1.0
    container_name: cloud-rmq-dashboard
    networks:
      service_net:
        ipv4_address: 172.28.0.65
    depends_on:
      - namesrv
    ports:
      - "${PORT_RMQ_DASHBOARD:-38082}:8082"
    environment:
      JAVA_OPTS: -Drocketmq.namesrv.addr=namesrv:9876 -Dcom.rocketmq.sendMessageWithVIPChannel=false

  # 兼容性注释已标准化。
  nginx:
    image: nginx:stable-perl
    container_name: cloud-nginx-gateway
    networks:
      service_net:
        ipv4_address: 172.28.0.70
    ports:
      - "${PORT_NGINX_HTTP:-18080}:80"      # 兼容性注释已标准化。
      - "${PORT_NGINX_HTTPS:-18443}:443"    # 兼容性注释已标准化。
    volumes:
      - type: bind
        source: ./docker-compose/nginx/config/nginx.conf
        target: /etc/nginx/nginx.conf
      - type: bind
        source: ./docker-compose/nginx/logs
        target: /var/log/nginx
      - type: bind
        source: ./docker-compose/nginx/html
        target: /usr/share/nginx/html
    depends_on:
      - nacos
  # 兼容性注释已标准化。
  minio:
    image: minio/minio:RELEASE.2025-07-23T15-54-02Z-cpuv1
    container_name: cloud-minio
    networks:
      service_net:
        ipv4_address: 172.28.0.80
    ports:
      - "${PORT_MINIO_API:-19000}:9000"
      - "${PORT_MINIO_CONSOLE:-19001}:9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    command: server /data --console-address ":9001"
    volumes:
      - type: bind
        source: ./docker-compose/minio/data
        target: /home/minio/data
  # 兼容性注释已标准化。
  elasticsearch:
    image: elasticsearch:9.1.2
    container_name: cloud-es-search
    networks:
      service_net:
        ipv4_address: 172.28.0.90  # 兼容性注释已标准化。
    environment:
      # 兼容性注释已标准化。
      - discovery.type=single-node  # 兼容性注释已标准化。
      - ES_JAVA_OPTS=-Xms1g -Xmx1g  # 兼容性注释已标准化。
      - bootstrap.memory_lock=true  # 兼容性注释已标准化。
      - xpack.security.enabled=false  # 兼容性注释已标准化。
      - http.cors.enabled=true
      - http.cors.allow-origin=" *"
    volumes:
      - type: bind
        source: ./docker-compose/elasticsearch/data
        target: /usr/share/elasticsearch/data
      - type: bind
        source: ./docker-compose/elasticsearch/plugins
        target: /usr/share/elasticsearch/plugins
    ports:
      - "${PORT_ES_HTTP:-19200}:9200"  # 兼容性注释已标准化。
      - "${PORT_ES_TRANSPORT:-19300}:9300"  # 兼容性注释已标准化。
    ulimits: # 兼容性注释已标准化。
      memlock:
        soft: -1
        hard: -1
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://127.0.0.1:9200" ]
      interval: 10s
      timeout: 5s
      retries: 12
  # Kibana
  kibana:
    image: kibana:9.1.2
    container_name: cloud-kibana-search
    depends_on:
      - elasticsearch
    networks:
      service_net:
        ipv4_address: 172.28.0.100
    ports:
      - "${PORT_KIBANA_HTTP:-15601}:5601"
    environment:
      # 兼容性注释已标准化。
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
      - SERVER_HOST=0.0.0.0
      - SERVER_NAME=kibana-service

      # 兼容性注释已标准化。
      - NODE_OPTIONS=--max-old-space-size=2048

      # 兼容性注释已标准化。
      - XPACK_APM_ENABLED=false
      - XPACK_INFRA_ENABLED=false
      - XPACK_MONITORING_UI_ENABLED=false
      - XPACK_OBSERVABILITY_ENABLED=false
      - TELEMETRY_ENABLED=false

      # 兼容性注释已标准化。
      - LOGGING_JSON_ENABLED=false
    volumes:
      - type: bind
        source: ./docker-compose/kibana/config
        target: /usr/share/kibana/config
        # 兼容性注释已标准化。
      - type: bind
        source: ./docker-compose/kibana/data
        target: /usr/share/kibana/data
    healthcheck: # 兼容性注释已标准化。
      test: [ "CMD", "curl", "-f", "http://127.0.0.1:5601/api/status" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  logstash:
    image: logstash:9.1.2
    container_name: cloud-logstash-sync
    depends_on:
      mysql:
        condition: service_healthy
      elasticsearch:
        condition: service_started
    networks:
      service_net:
        ipv4_address: 172.28.0.110
    ports:
      - "${PORT_LOGSTASH_BEATS:-15044}:5044"
      - "${PORT_LOGSTASH_API:-19600}:9600"
    environment:
      MYSQL_HOST: cloud-mysql
      MYSQL_PORT: 3306
      MYSQL_DATABASE: product_db
      MYSQL_USER: root
      MYSQL_PASSWORD: root
      ES_HOST: elasticsearch
      ES_PORT: 9200
    volumes:
      - type: bind
        source: ./monitor/logstash/config/logstash.yml
        target: /usr/share/logstash/config/logstash.yml
      - type: bind
        source: ./monitor/logstash/pipeline
        target: /usr/share/logstash/pipeline
      - type: bind
        source: ./monitor/logstash/logs
        target: /usr/share/logstash/logs
      - type: bind
        source: ./monitor/logstash/drivers
        target: /usr/share/logstash/drivers
      - type: bind
        source: ../auth-service/logs
        target: /workspace/service-logs/auth-service
        read_only: true
      - type: bind
        source: ../gateway/logs
        target: /workspace/service-logs/gateway
        read_only: true
      - type: bind
        source: ../user-service/logs
        target: /workspace/service-logs/user-service
        read_only: true
      - type: bind
        source: ../order-service/logs
        target: /workspace/service-logs/order-service
        read_only: true
      - type: bind
        source: ../stock-service/logs
        target: /workspace/service-logs/stock-service
        read_only: true
      - type: bind
        source: ../payment-service/logs
        target: /workspace/service-logs/payment-service
        read_only: true
      - type: bind
        source: ../product-service/logs
        target: /workspace/service-logs/product-service
        read_only: true
      - type: bind
        source: ../search-service/logs
        target: /workspace/service-logs/search-service
        read_only: true
      - type: bind
        source: ../logs
        target: /workspace/service-logs/shared
        read_only: true
# 兼容性注释已标准化。
networks:
  service_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/24
          gateway: 172.28.0.1


