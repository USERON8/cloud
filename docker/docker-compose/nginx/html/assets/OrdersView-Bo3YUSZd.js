import{t as e}from"./css-E3i9oLPS.js";import{Mt as t,P as n,R as r,X as i,Y as a,_ as o,d as s,f as c,j as l,lt as u,m as ee,p as d,rt as f,t as p,tt as m,u as h,v as g,y as _}from"./_plugin-vue_export-helper-Db-PtwND.js";import"./session-C5oAodxY.js";import{n as v,t as y}from"./index-COPDY7zS.js";import{n as te,r as b,t as x}from"./css-CraHvIK0.js";import"./css-BuQUL2TQ.js";import{a as S,i as C,n as w,o as T,r as ne,t as E}from"./css-4BLFpeg6.js";import{t as D}from"./message-CbR1IZY7.js";import"./http-D8xhHfNR.js";import{a as O,c as k,i as re,l as ie,n as ae,o as oe,r as se,s as A,t as ce,u as le}from"./order-D4p09QkI.js";var ue={class:`glass-card panel`},de={class:`header`},fe={class:`header-actions`},j={class:`filters`},M={class:`batch-actions`},N={class:`pager`},P=5,F=p(_({__name:`OrdersView`,setup(p){let _=v(),F=f(!1),I=f(!1),L=f(!1),R=f([]),z=f([]),B=f(0),V=m({page:1,size:10,status:void 0,userId:void 0,shopId:void 0}),{isAdmin:H,isMerchant:U,isUser:pe}=y(),W=h(()=>!!_.meta.manageOrder),me=h(()=>U.value||H.value),G=h(()=>!W.value&&(pe.value||H.value)),K=h(()=>W.value&&(U.value||H.value));function q(e){switch(e){case 0:return`Pending Payment`;case 1:return`Paid`;case 2:return`Shipped`;case 3:return`Completed`;case 4:return`Cancelled`;default:return`Unknown`}}function he(e){return e===0?`warning`:e===1||e===3?`success`:`info`}function ge(e){return typeof e==`number`?`CNY ${e.toFixed(2)}`:`--`}function _e(e){return e.status===0&&G.value}function ve(e){return(e.status===0||e.status===1)&&G.value}function ye(e){return e.status===1&&K.value}function be(e){return e.status===2&&G.value}function J(e){return z.value.filter(t=>typeof t.id==`number`&&t.status!=null&&e.includes(t.status)).map(e=>e.id)}function Y(e,t){return e.length>0?!0:(D.warning(`Select at least one order for ${t}.`),!1)}async function X(){F.value=!0,z.value=[];try{let e=await k({page:V.page,size:V.size,status:V.status,userId:H.value?V.userId:void 0,shopId:H.value?V.shopId:void 0});R.value=e.records,B.value=e.total}catch(e){let t=e instanceof Error?e.message:`Failed to load orders`;D.error(t)}finally{F.value=!1}}function xe(){V.page=1,X()}function Se(){V.status=void 0,V.userId=void 0,V.shopId=void 0,V.page=1,X()}function Ce(e){z.value=e}async function we(e){try{await ie(e.id),D.success(`Order ${e.orderNo} paid.`),await X()}catch(e){let t=e instanceof Error?e.message:`Pay action failed`;D.error(t)}}async function Te(e){try{await E.confirm(`Ship order ${e.orderNo}?`,`Confirm`,{type:`warning`}),await le(e.id),D.success(`Order ${e.orderNo} shipped.`),await X()}catch(e){e instanceof Error&&e.message!==`cancel`&&D.error(e.message)}}async function Ee(e){try{await E.confirm(`Complete order ${e.orderNo}?`,`Confirm`,{type:`warning`}),await oe(e.id),D.success(`Order ${e.orderNo} completed.`),await X()}catch(e){e instanceof Error&&e.message!==`cancel`&&D.error(e.message)}}async function Z(e){try{await E.confirm(`Cancel order ${e.orderNo}?`,`Confirm`,{type:`warning`}),await O(e.id,`Cancelled from web portal`),D.success(`Order ${e.orderNo} cancelled.`),await X()}catch(e){e instanceof Error&&e.message!==`cancel`&&D.error(e.message)}}async function De(){let e=J([0]);Y(e,`batch pay`)&&await Q(e,`pay`,e=>se(e))}async function Oe(){let e=J([0,1]);Y(e,`batch cancel`)&&await Q(e,`cancel`,e=>ce(e,`Cancelled from web portal`))}async function ke(){let e=J([2]);Y(e,`batch complete`)&&await Q(e,`complete`,e=>ae(e))}async function Ae(){let e=J([1]);Y(e,`batch ship`)&&await Q(e,`ship`,e=>re(e))}function je(e){return e===`pay`?1:e===`ship`?2:e===`complete`?3:4}async function Me(e,t){let n=await Ne(e,P,async e=>{let n=await A(e);return(n==null?void 0:n.status)===t});return e.filter(e=>n.get(e)!==!0)}async function Q(e,t,n){if(!I.value){I.value=!0;try{let r=await n(e),i=typeof r==`number`?r:0,a=[];i<e.length&&(a=await Me(e,je(t))),D.success(`Batch ${t} completed: ${i}/${e.length}.`),a.length>0&&await E.alert(`Failed order IDs: ${a.join(`, `)}`,`Batch ${t} partial failure`,{type:`warning`}),await X()}catch(e){let n=e instanceof Error?e.message:`Batch ${t} failed`;D.error(n)}finally{I.value=!1}}}async function Ne(e,t,n){let r=new Map,i=Math.max(1,Math.min(t,e.length)),a=0,o=Array.from({length:i},async()=>{for(;;){let t=a;if(a+=1,t>=e.length)return;let i=e[t];if(typeof i==`number`)try{r.set(i,await n(i)===!0)}catch(e){r.set(i,!1)}}});return await Promise.all(o),r}function $(e){return e.includes(`"`)||e.includes(`,`)||e.includes(`
`)?`"${e.replace(/"/g,`""`)}"`:e}async function Pe(){if(!L.value){L.value=!0;try{let e=await Fe();if(e.length===0){D.warning(`No orders to export under current filters.`);return}let t=[[`id`,`order_no`,`user_id`,`shop_id`,`status`,`total_amount`,`pay_amount`,`created_at`].join(`,`)];e.forEach(e=>{var n,r,i,a,o,s,c;let l=[String((n=e.id)==null?``:n),$((r=e.orderNo)==null?``:r),String((i=e.userId)==null?``:i),String((a=e.shopId)==null?``:a),$(q(e.status)),String((o=e.totalAmount)==null?``:o),String((s=e.payAmount)==null?``:s),$((c=e.createdAt)==null?``:c)];t.push(l.join(`,`))});let n=t.join(`
`),r=new Blob([n],{type:`text/csv;charset=utf-8;`}),i=URL.createObjectURL(r),a=document.createElement(`a`);a.href=i,a.download=`orders-export-${Date.now()}.csv`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(i),D.success(`Exported ${e.length} orders.`)}catch(e){let t=e instanceof Error?e.message:`Failed to export CSV`;D.error(t)}finally{L.value=!1}}}async function Fe(){let e=[],t=1;for(;;){let n=await k({page:t,size:200,status:V.status,userId:H.value?V.userId:void 0,shopId:H.value?V.shopId:void 0});if(e.push(...n.records),n.records.length===0||t>=n.pages)break;t+=1}return e}return l(()=>{X()}),(l,f)=>{let p=e,m=r(`router-link`),h=x,_=te,v=T,y=C,E=b,D=ne,O=S,k=w;return n(),ee(`section`,ue,[s(`div`,de,[s(`h3`,null,t(W.value?`Order Management`:`Orders`),1),s(`div`,fe,[me.value&&!W.value?(n(),c(m,{key:0,class:`inline-link`,to:`/orders/manage`},{default:a(()=>[g(p,{round:``,type:`success`},{default:a(()=>[...f[5]||(f[5]=[o(`Open Management`,-1)])]),_:1})]),_:1})):d(``,!0),W.value?(n(),c(m,{key:1,class:`inline-link`,to:`/orders`},{default:a(()=>[g(p,{round:``},{default:a(()=>[...f[6]||(f[6]=[o(`Back to Orders`,-1)])]),_:1})]),_:1})):d(``,!0),g(p,{loading:L.value,round:``,onClick:Pe},{default:a(()=>[...f[7]||(f[7]=[o(`Export CSV`,-1)])]),_:1},8,[`loading`]),g(p,{loading:F.value,round:``,onClick:X},{default:a(()=>[...f[8]||(f[8]=[o(`Refresh`,-1)])]),_:1},8,[`loading`])])]),s(`div`,j,[g(_,{modelValue:V.status,"onUpdate:modelValue":f[0]||(f[0]=e=>V.status=e),clearable:``,placeholder:`Status`},{default:a(()=>[g(h,{value:0,label:`Pending Payment`}),g(h,{value:1,label:`Paid`}),g(h,{value:2,label:`Shipped`}),g(h,{value:3,label:`Completed`}),g(h,{value:4,label:`Cancelled`})]),_:1},8,[`modelValue`]),u(H)?(n(),c(v,{key:0,modelValue:V.userId,"onUpdate:modelValue":f[1]||(f[1]=e=>V.userId=e),min:1,"controls-position":`right`,placeholder:`User ID`},null,8,[`modelValue`])):d(``,!0),u(H)?(n(),c(v,{key:1,modelValue:V.shopId,"onUpdate:modelValue":f[2]||(f[2]=e=>V.shopId=e),min:1,"controls-position":`right`,placeholder:`Shop ID`},null,8,[`modelValue`])):d(``,!0),g(p,{round:``,type:`primary`,onClick:xe},{default:a(()=>[...f[9]||(f[9]=[o(`Search`,-1)])]),_:1}),g(p,{round:``,onClick:Se},{default:a(()=>[...f[10]||(f[10]=[o(`Reset`,-1)])]),_:1})]),s(`div`,M,[G.value?(n(),c(p,{key:0,disabled:I.value,loading:I.value,round:``,size:`small`,type:`primary`,onClick:De},{default:a(()=>[...f[11]||(f[11]=[o(` Batch Pay `,-1)])]),_:1},8,[`disabled`,`loading`])):d(``,!0),G.value?(n(),c(p,{key:1,disabled:I.value,round:``,size:`small`,onClick:Oe},{default:a(()=>[...f[12]||(f[12]=[o(` Batch Cancel `,-1)])]),_:1},8,[`disabled`])):d(``,!0),G.value?(n(),c(p,{key:2,disabled:I.value,round:``,size:`small`,type:`success`,plain:``,onClick:ke},{default:a(()=>[...f[13]||(f[13]=[o(` Batch Complete `,-1)])]),_:1},8,[`disabled`])):d(``,!0),K.value?(n(),c(p,{key:3,disabled:I.value,round:``,size:`small`,type:`primary`,plain:``,onClick:Ae},{default:a(()=>[...f[14]||(f[14]=[o(` Batch Ship `,-1)])]),_:1},8,[`disabled`])):d(``,!0)]),i((n(),c(D,{data:R.value,stripe:``,onSelectionChange:Ce},{default:a(()=>[g(y,{type:`selection`,width:`50`}),g(y,{label:`Order No`,"min-width":`220`,prop:`orderNo`}),u(H)?(n(),c(y,{key:0,label:`Shop ID`,"min-width":`120`,prop:`shopId`})):d(``,!0),g(y,{label:`Amount`,"min-width":`130`},{default:a(e=>[o(t(ge(e.row.totalAmount)),1)]),_:1}),g(y,{label:`Status`,"min-width":`160`},{default:a(e=>[g(E,{type:he(e.row.status),round:``},{default:a(()=>[o(t(q(e.row.status)),1)]),_:2},1032,[`type`])]),_:1}),g(y,{label:`Created At`,"min-width":`200`,prop:`createdAt`}),g(y,{label:`Actions`,width:`360`},{default:a(e=>[_e(e.row)?(n(),c(p,{key:0,round:``,size:`small`,type:`primary`,onClick:t=>we(e.row)},{default:a(()=>[...f[15]||(f[15]=[o(` Pay `,-1)])]),_:1},8,[`onClick`])):d(``,!0),ve(e.row)?(n(),c(p,{key:1,round:``,size:`small`,onClick:t=>Z(e.row)},{default:a(()=>[...f[16]||(f[16]=[o(` Cancel `,-1)])]),_:1},8,[`onClick`])):d(``,!0),ye(e.row)?(n(),c(p,{key:2,round:``,size:`small`,type:`primary`,plain:``,onClick:t=>Te(e.row)},{default:a(()=>[...f[17]||(f[17]=[o(` Ship `,-1)])]),_:1},8,[`onClick`])):d(``,!0),be(e.row)?(n(),c(p,{key:3,round:``,size:`small`,type:`success`,plain:``,onClick:t=>Ee(e.row)},{default:a(()=>[...f[18]||(f[18]=[o(` Complete `,-1)])]),_:1},8,[`onClick`])):d(``,!0)]),_:1})]),_:1},8,[`data`])),[[k,F.value]]),s(`div`,N,[g(O,{"current-page":V.page,"onUpdate:currentPage":f[3]||(f[3]=e=>V.page=e),"page-size":V.size,"onUpdate:pageSize":f[4]||(f[4]=e=>V.size=e),"page-sizes":[10,20,50],total:B.value,background:``,layout:`total, sizes, prev, pager, next`,onCurrentChange:X,onSizeChange:X},null,8,[`current-page`,`page-size`,`total`])])])}}}),[[`__scopeId`,`data-v-6f0ed4ce`]]);export{F as default};