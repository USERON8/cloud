import{F as e,M as t,Nt as n,X as r,Z as i,b as a,d as o,f as s,it as c,m as l,nt as u,p as d,t as f,u as p,ut as m,v as h,y as g,z as ee}from"./_plugin-vue_export-helper-7ehu3f-T.js";import"./http-BtjM28wp.js";import{n as _,t as v}from"./index-D_UHLrTq.js";import{t as te}from"./css-DepZNlzm.js";import{n as ne,r as re,t as y}from"./css-DjVlAzPB.js";import"./css-BaDt1NEF.js";import{a as b,i as x,n as S,o as C,r as w,t as T}from"./css-Dd9aHQFP.js";import{t as E}from"./message-CA9T8QLS.js";import{a as D,c as O,i as ie,l as ae,n as oe,o as se,r as ce,s as le,t as ue,u as de}from"./order-B5XGFXEa.js";var fe={class:`glass-card panel`},pe={class:`header`},k={class:`title-wrap`},A={class:`header-actions`},j={class:`filters`},M={class:`batch-actions`},N={class:`pager`},P=5,F=f(a({__name:`OrdersView`,setup(a){let f=_(),F=c(!1),I=c(!1),L=c(!1),R=c([]),z=c([]),B=c(0),V=u({page:1,size:10,status:void 0,userId:void 0,shopId:void 0}),{isAdmin:H,isMerchant:U,isUser:me}=v(),W=p(()=>!!f.meta.manageOrder),he=p(()=>U.value||H.value),G=p(()=>!W.value&&(me.value||H.value)),K=p(()=>W.value&&(U.value||H.value));function q(e){switch(e){case 0:return`Pending Payment`;case 1:return`Paid`;case 2:return`Shipped`;case 3:return`Completed`;case 4:return`Cancelled`;default:return`Unknown`}}function ge(e){return e===0?`warning`:e===1||e===3?`success`:`info`}function _e(e){return typeof e==`number`?`CNY ${e.toFixed(2)}`:`--`}function ve(e){return e.status===0&&G.value}function ye(e){return(e.status===0||e.status===1)&&G.value}function be(e){return e.status===1&&K.value}function xe(e){return e.status===2&&G.value}function J(e){return z.value.filter(t=>typeof t.id==`number`&&t.status!=null&&e.includes(t.status)).map(e=>e.id)}function Y(e,t){return e.length>0?!0:(E.warning(`Select at least one order for ${t}.`),!1)}async function X(){F.value=!0,z.value=[];try{let e=await O({page:V.page,size:V.size,status:V.status,userId:H.value?V.userId:void 0,shopId:H.value?V.shopId:void 0});R.value=e.records,B.value=e.total}catch(e){let t=e instanceof Error?e.message:`Failed to load orders`;E.error(t)}finally{F.value=!1}}function Se(){V.page=1,X()}function Ce(){V.status=void 0,V.userId=void 0,V.shopId=void 0,V.page=1,X()}function we(e){z.value=e}async function Te(e){try{await ae(e.id),E.success(`Order ${e.orderNo} paid.`),await X()}catch(e){let t=e instanceof Error?e.message:`Pay action failed`;E.error(t)}}async function Ee(e){try{await T.confirm(`Ship order ${e.orderNo}?`,`Confirm`,{type:`warning`}),await de(e.id),E.success(`Order ${e.orderNo} shipped.`),await X()}catch(e){e instanceof Error&&e.message!==`cancel`&&E.error(e.message)}}async function De(e){try{await T.confirm(`Complete order ${e.orderNo}?`,`Confirm`,{type:`warning`}),await se(e.id),E.success(`Order ${e.orderNo} completed.`),await X()}catch(e){e instanceof Error&&e.message!==`cancel`&&E.error(e.message)}}async function Oe(e){try{await T.confirm(`Cancel order ${e.orderNo}?`,`Confirm`,{type:`warning`}),await D(e.id,`Cancelled from web portal`),E.success(`Order ${e.orderNo} cancelled.`),await X()}catch(e){e instanceof Error&&e.message!==`cancel`&&E.error(e.message)}}async function ke(){let e=J([0]);Y(e,`batch pay`)&&await Q(e,`pay`,e=>ce(e))}async function Z(){let e=J([0,1]);Y(e,`batch cancel`)&&await Q(e,`cancel`,e=>ue(e,`Cancelled from web portal`))}async function Ae(){let e=J([2]);Y(e,`batch complete`)&&await Q(e,`complete`,e=>oe(e))}async function je(){let e=J([1]);Y(e,`batch ship`)&&await Q(e,`ship`,e=>ie(e))}function Me(e){return e===`pay`?1:e===`ship`?2:e===`complete`?3:4}async function Ne(e,t){let n=await Pe(e,P,async e=>{let n=await le(e);return(n==null?void 0:n.status)===t});return e.filter(e=>n.get(e)!==!0)}async function Q(e,t,n){if(!I.value){I.value=!0;try{let r=await n(e),i=typeof r==`number`?r:0,a=[];i<e.length&&(a=await Ne(e,Me(t))),E.success(`Batch ${t} completed: ${i}/${e.length}.`),a.length>0&&await T.alert(`Failed order IDs: ${a.join(`, `)}`,`Batch ${t} partial failure`,{type:`warning`}),await X()}catch(e){let n=e instanceof Error?e.message:`Batch ${t} failed`;E.error(n)}finally{I.value=!1}}}async function Pe(e,t,n){let r=new Map,i=Math.max(1,Math.min(t,e.length)),a=0,o=Array.from({length:i},async()=>{for(;;){let t=a;if(a+=1,t>=e.length)return;let i=e[t];if(typeof i==`number`)try{r.set(i,await n(i)===!0)}catch(e){r.set(i,!1)}}});return await Promise.all(o),r}function $(e){return e.includes(`"`)||e.includes(`,`)||e.includes(`
`)?`"${e.replace(/"/g,`""`)}"`:e}async function Fe(){if(!L.value){L.value=!0;try{let e=await Ie();if(e.length===0){E.warning(`No orders to export under current filters.`);return}let t=[[`id`,`order_no`,`user_id`,`shop_id`,`status`,`total_amount`,`pay_amount`,`created_at`].join(`,`)];e.forEach(e=>{var n,r,i,a,o,s,c;let l=[String((n=e.id)==null?``:n),$((r=e.orderNo)==null?``:r),String((i=e.userId)==null?``:i),String((a=e.shopId)==null?``:a),$(q(e.status)),String((o=e.totalAmount)==null?``:o),String((s=e.payAmount)==null?``:s),$((c=e.createdAt)==null?``:c)];t.push(l.join(`,`))});let n=t.join(`
`),r=new Blob([n],{type:`text/csv;charset=utf-8;`}),i=URL.createObjectURL(r),a=document.createElement(`a`);a.href=i,a.download=`orders-export-${Date.now()}.csv`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(i),E.success(`Exported ${e.length} orders.`)}catch(e){let t=e instanceof Error?e.message:`Failed to export CSV`;E.error(t)}finally{L.value=!1}}}async function Ie(){let e=[],t=1;for(;;){let n=await O({page:t,size:200,status:V.status,userId:H.value?V.userId:void 0,shopId:H.value?V.shopId:void 0});if(e.push(...n.records),n.records.length===0||t>=n.pages)break;t+=1}return e}return t(()=>{X()}),(t,a)=>{let c=te,u=ee(`router-link`),f=y,p=ne,_=C,v=x,T=re,E=w,D=b,O=S;return e(),l(`section`,fe,[o(`div`,pe,[o(`h3`,null,[o(`span`,k,[a[5]||(a[5]=o(`svg`,{viewBox:`0 0 24 24`,"aria-hidden":`true`},[o(`path`,{d:`M6 5h10l3 3v11H6V5Zm10 0v3h3M9 12h6M9 15h6`})],-1)),h(` `+n(W.value?`Order Management`:`Orders`),1)])]),o(`div`,A,[he.value&&!W.value?(e(),s(u,{key:0,class:`inline-link`,to:`/app/orders/manage`},{default:r(()=>[g(c,{round:``,type:`success`},{default:r(()=>[...a[6]||(a[6]=[h(`Open Management`,-1)])]),_:1})]),_:1})):d(``,!0),W.value?(e(),s(u,{key:1,class:`inline-link`,to:`/app/orders`},{default:r(()=>[g(c,{round:``},{default:r(()=>[...a[7]||(a[7]=[h(`Back to Orders`,-1)])]),_:1})]),_:1})):d(``,!0),g(c,{loading:L.value,round:``,onClick:Fe},{default:r(()=>[...a[8]||(a[8]=[o(`span`,{class:`btn-wrap`},[o(`svg`,{viewBox:`0 0 24 24`,"aria-hidden":`true`},[o(`path`,{d:`M12 4v10M8 10l4 4 4-4M5 18h14`})]),h(` Export CSV `)],-1)])]),_:1},8,[`loading`]),g(c,{loading:F.value,round:``,onClick:X},{default:r(()=>[...a[9]||(a[9]=[o(`span`,{class:`btn-wrap`},[o(`svg`,{viewBox:`0 0 24 24`,"aria-hidden":`true`},[o(`path`,{d:`M19 6v5h-5M5 18v-5h5M19 11a7 7 0 0 0-12-3M5 13a7 7 0 0 0 12 3`})]),h(` Refresh `)],-1)])]),_:1},8,[`loading`])])]),o(`div`,j,[g(p,{modelValue:V.status,"onUpdate:modelValue":a[0]||(a[0]=e=>V.status=e),clearable:``,placeholder:`Status`},{default:r(()=>[g(f,{value:0,label:`Pending Payment`}),g(f,{value:1,label:`Paid`}),g(f,{value:2,label:`Shipped`}),g(f,{value:3,label:`Completed`}),g(f,{value:4,label:`Cancelled`})]),_:1},8,[`modelValue`]),m(H)?(e(),s(_,{key:0,modelValue:V.userId,"onUpdate:modelValue":a[1]||(a[1]=e=>V.userId=e),min:1,"controls-position":`right`,placeholder:`User ID`},null,8,[`modelValue`])):d(``,!0),m(H)?(e(),s(_,{key:1,modelValue:V.shopId,"onUpdate:modelValue":a[2]||(a[2]=e=>V.shopId=e),min:1,"controls-position":`right`,placeholder:`Shop ID`},null,8,[`modelValue`])):d(``,!0),g(c,{round:``,type:`primary`,onClick:Se},{default:r(()=>[...a[10]||(a[10]=[h(`Search`,-1)])]),_:1}),g(c,{round:``,onClick:Ce},{default:r(()=>[...a[11]||(a[11]=[h(`Reset`,-1)])]),_:1})]),o(`div`,M,[G.value?(e(),s(c,{key:0,disabled:I.value,loading:I.value,round:``,size:`small`,type:`primary`,onClick:ke},{default:r(()=>[...a[12]||(a[12]=[h(` Batch Pay `,-1)])]),_:1},8,[`disabled`,`loading`])):d(``,!0),G.value?(e(),s(c,{key:1,disabled:I.value,round:``,size:`small`,onClick:Z},{default:r(()=>[...a[13]||(a[13]=[h(` Batch Cancel `,-1)])]),_:1},8,[`disabled`])):d(``,!0),G.value?(e(),s(c,{key:2,disabled:I.value,round:``,size:`small`,type:`success`,plain:``,onClick:Ae},{default:r(()=>[...a[14]||(a[14]=[h(` Batch Complete `,-1)])]),_:1},8,[`disabled`])):d(``,!0),K.value?(e(),s(c,{key:3,disabled:I.value,round:``,size:`small`,type:`primary`,plain:``,onClick:je},{default:r(()=>[...a[15]||(a[15]=[h(` Batch Ship `,-1)])]),_:1},8,[`disabled`])):d(``,!0)]),i((e(),s(E,{data:R.value,stripe:``,onSelectionChange:we},{default:r(()=>[g(v,{type:`selection`,width:`50`}),g(v,{label:`Order No`,"min-width":`220`,prop:`orderNo`}),m(H)?(e(),s(v,{key:0,label:`Shop ID`,"min-width":`120`,prop:`shopId`})):d(``,!0),g(v,{label:`Amount`,"min-width":`130`},{default:r(e=>[h(n(_e(e.row.totalAmount)),1)]),_:1}),g(v,{label:`Status`,"min-width":`160`},{default:r(e=>[g(T,{type:ge(e.row.status),round:``},{default:r(()=>[h(n(q(e.row.status)),1)]),_:2},1032,[`type`])]),_:1}),g(v,{label:`Created At`,"min-width":`200`,prop:`createdAt`}),g(v,{label:`Actions`,width:`360`},{default:r(t=>[ve(t.row)?(e(),s(c,{key:0,round:``,size:`small`,type:`primary`,onClick:e=>Te(t.row)},{default:r(()=>[...a[16]||(a[16]=[h(` Pay `,-1)])]),_:1},8,[`onClick`])):d(``,!0),ye(t.row)?(e(),s(c,{key:1,round:``,size:`small`,onClick:e=>Oe(t.row)},{default:r(()=>[...a[17]||(a[17]=[h(` Cancel `,-1)])]),_:1},8,[`onClick`])):d(``,!0),be(t.row)?(e(),s(c,{key:2,round:``,size:`small`,type:`primary`,plain:``,onClick:e=>Ee(t.row)},{default:r(()=>[...a[18]||(a[18]=[h(` Ship `,-1)])]),_:1},8,[`onClick`])):d(``,!0),xe(t.row)?(e(),s(c,{key:3,round:``,size:`small`,type:`success`,plain:``,onClick:e=>De(t.row)},{default:r(()=>[...a[19]||(a[19]=[h(` Complete `,-1)])]),_:1},8,[`onClick`])):d(``,!0)]),_:1})]),_:1},8,[`data`])),[[O,F.value]]),o(`div`,N,[g(D,{"current-page":V.page,"onUpdate:currentPage":a[3]||(a[3]=e=>V.page=e),"page-size":V.size,"onUpdate:pageSize":a[4]||(a[4]=e=>V.size=e),"page-sizes":[10,20,50],total:B.value,background:``,layout:`total, sizes, prev, pager, next`,onCurrentChange:X,onSizeChange:X},null,8,[`current-page`,`page-size`,`total`])])])}}}),[[`__scopeId`,`data-v-3f5e6a09`]]);export{F as default};