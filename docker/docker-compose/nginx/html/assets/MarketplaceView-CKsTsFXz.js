import{t as e}from"./css-gYsclK9r.js";import{F as t,L as n,M as r,Nt as i,X as a,_ as ee,a as o,b as s,d as c,f as te,it as l,m as u,p as d,t as f,u as p,v as m,y as h}from"./_plugin-vue_export-helper-CS_DzLMV.js";import{a as g,h as _,s as v}from"./session-ki_suUwh.js";import{r as ne}from"./index-D2O9aft2.js";import{t as re}from"./css-PREK1Btt.js";import{t as ie}from"./css-B4r8G6Fv.js";import{t as ae}from"./message-DyMrUQQL.js";import{t as y}from"./css-XwD9khEw.js";import"./http-CgWw7_UJ.js";import{o as oe}from"./product-DLzNnWWs.js";var b={class:`market-page`},se={class:`glass-card topbar`},ce={class:`brand-wrap`},le={class:`sub`},ue={class:`entry-actions`},de={class:`glass-card search-hero`},fe={class:`search-line`},pe={class:`quick-actions`},me={class:`glass-card rates-panel`},x={class:`rates-head`},S={key:0,class:`rate-time`},C={class:`rate-grid`},w={class:`rate-card`},T={class:`rate-card`},E={class:`rate-card`},D={class:`rate-card`},O={class:`section-head`},k={class:`shop-grid`},A=[`onClick`],j={class:`section-head`},M={class:`product-grid`},N=[`onClick`],P={class:`muted`},F={class:`price`},I={class:`login-gate-text`},L={class:`login-gate-actions`},R=f(s({__name:`MarketplaceView`,setup(s){let f=ne(),R=l(!1),z=l(``),B=l([]),V=l([]),H=l(!1),U=l(`/login`),W=l(``),G=l(!1),K=l(``),q=l(``),J=l({JPY:0,USD:0,EUR:0,GBP:0}),he=p(()=>{var e,t;return((e=v.user)==null?void 0:e.nickname)||((t=v.user)==null?void 0:t.username)||`访客`}),ge=p(()=>g()?`已登录`:`未登录`),Y=p(()=>B.value.slice(0,12)),X=p(()=>V.value.slice(0,8));function _e(e){return e.filter(e=>e.status===1&&typeof e.productId==`number`)}function ve(e){let t=new Map;return e.forEach(e=>{if(typeof e.shopId!=`number`||typeof e.price!=`number`)return;let n=t.get(e.shopId);if(!n){var r;t.set(e.shopId,{id:e.shopId,name:((r=e.shopName)==null?void 0:r.trim())||`Shop #${e.shopId}`,productCount:1,minPrice:e.price,maxPrice:e.price});return}n.productCount+=1,n.minPrice=Math.min(n.minPrice,e.price),n.maxPrice=Math.max(n.maxPrice,e.price)}),[...t.values()].sort((e,t)=>t.productCount-e.productCount)}async function Z(){R.value=!0;try{let e=_e((await oe({keyword:z.value.trim()||void 0,page:1,size:80,sortField:`score`,sortOrder:`desc`})).documents||[]);B.value=e,V.value=ve(e)}catch(e){let t=e instanceof Error?e.message:`加载首页失败`;ae.error(t)}finally{R.value=!1}}async function Q(){G.value=!0,K.value=``;try{var e,t,n,r;let i=await fetch(`https://api.frankfurter.app/latest?from=CNY&to=JPY,USD,EUR,GBP`);if(!i.ok)throw Error(`汇率接口异常: HTTP ${i.status}`);let a=await i.json();J.value={JPY:Number(((e=a.rates)==null?void 0:e.JPY)||0),USD:Number(((t=a.rates)==null?void 0:t.USD)||0),EUR:Number(((n=a.rates)==null?void 0:n.EUR)||0),GBP:Number(((r=a.rates)==null?void 0:r.GBP)||0)},q.value=a.date||``}catch(e){K.value=e instanceof Error?e.message:`汇率加载失败`}finally{G.value=!1}}async function $(e,t){if(g()){await f.push(e);return}U.value=e,W.value=t,H.value=!0}async function ye(){H.value=!1,await f.push({path:`/login`,query:{redirect:U.value}})}function be(e){f.push({path:`/app/catalog`,query:{keyword:e}})}return r(()=>{Z(),Q()}),(r,s)=>{let l=e,f=re,p=ie,g=y;return t(),u(`div`,b,[c(`header`,se,[c(`div`,ce,[s[8]||(s[8]=c(`p`,{class:`eyebrow`},`My Shop Marketplace`,-1)),s[9]||(s[9]=c(`h1`,null,`认证商家与在售商品`,-1)),c(`p`,le,`当前用户：`+i(he.value)+` · `+i(ge.value)+` · 可先浏览再登录`,1)]),c(`div`,ue,[h(l,{round:``,onClick:s[0]||(s[0]=e=>r.$router.push(`/login`))},{default:a(()=>[...s[10]||(s[10]=[m(`用户登录`,-1)])]),_:1}),h(l,{round:``,type:`primary`,onClick:s[1]||(s[1]=e=>r.$router.push(`/login?entry=merchant`))},{default:a(()=>[...s[11]||(s[11]=[m(`商家登录入口`,-1)])]),_:1})])]),c(`section`,de,[c(`div`,fe,[h(f,{modelValue:z.value,"onUpdate:modelValue":s[2]||(s[2]=e=>z.value=e),clearable:``,placeholder:`搜索已开店商家 / 已上架商品`,onKeyup:_(Z,[`enter`])},null,8,[`modelValue`]),h(l,{loading:R.value,round:``,type:`primary`,onClick:Z},{default:a(()=>[...s[12]||(s[12]=[m(`搜索`,-1)])]),_:1},8,[`loading`])]),c(`div`,pe,[h(l,{round:``,onClick:s[3]||(s[3]=e=>$(`/app/orders`,`订单管理`))},{default:a(()=>[...s[13]||(s[13]=[m(`我的订单`,-1)])]),_:1}),h(l,{round:``,onClick:s[4]||(s[4]=e=>$(`/app/profile`,`个人中心`))},{default:a(()=>[...s[14]||(s[14]=[m(`个人中心`,-1)])]),_:1}),h(l,{round:``,onClick:s[5]||(s[5]=e=>$(`/app/catalog/manage`,`商家商品管理`))},{default:a(()=>[...s[15]||(s[15]=[m(`商家管理`,-1)])]),_:1})])]),c(`section`,me,[c(`div`,x,[s[17]||(s[17]=c(`h2`,null,`实时汇率面板（基准：1 CNY）`,-1)),h(l,{loading:G.value,round:``,size:`small`,onClick:Q},{default:a(()=>[...s[16]||(s[16]=[m(`刷新汇率`,-1)])]),_:1},8,[`loading`])]),q.value?(t(),u(`p`,S,`更新时间：`+i(q.value),1)):d(``,!0),K.value?(t(),te(p,{key:1,closable:!1,"show-icon":``,type:`warning`,title:K.value},null,8,[`title`])):d(``,!0),c(`div`,C,[c(`article`,w,[s[18]||(s[18]=c(`p`,null,`日元 ¥ (JPY)`,-1)),c(`strong`,null,`¥ `+i(J.value.JPY.toFixed(4)),1)]),c(`article`,T,[s[19]||(s[19]=c(`p`,null,`美元 $ (USD)`,-1)),c(`strong`,null,`$ `+i(J.value.USD.toFixed(4)),1)]),c(`article`,E,[s[20]||(s[20]=c(`p`,null,`欧元 € (EUR)`,-1)),c(`strong`,null,`€ `+i(J.value.EUR.toFixed(4)),1)]),c(`article`,D,[s[21]||(s[21]=c(`p`,null,`英镑 £ (GBP)`,-1)),c(`strong`,null,`£ `+i(J.value.GBP.toFixed(4)),1)])])]),c(`section`,O,[s[22]||(s[22]=c(`h2`,null,`已认证已开店商家`,-1)),c(`span`,null,i(X.value.length)+` 家`,1)]),c(`section`,k,[(t(!0),u(o,null,n(X.value,e=>(t(),u(`article`,{key:e.id,class:`glass-card shop-card`,onClick:t=>{z.value=e.name,Z()}},[s[23]||(s[23]=c(`div`,{class:`badges`},[c(`span`,{class:`badge verified`},`已认证`),c(`span`,{class:`badge open`},`已开店`)],-1)),c(`h3`,null,i(e.name),1),c(`p`,null,`在售商品 `+i(e.productCount)+` 件`,1),c(`p`,null,`价格带 CNY `+i(e.minPrice.toFixed(2))+` ~ `+i(e.maxPrice.toFixed(2)),1)],8,A))),128))]),c(`section`,j,[s[24]||(s[24]=c(`h2`,null,`已上架商品`,-1)),c(`span`,null,i(Y.value.length)+` 件`,1)]),c(`section`,M,[(t(!0),u(o,null,n(Y.value,e=>{var n;return t(),u(`article`,{key:e.productId,class:`glass-card product-card`,onClick:t=>be(e.productName||``)},[s[25]||(s[25]=ee(`<div class="cover-svg" aria-hidden="true" data-v-6b0ce1b8><svg viewBox="0 0 120 80" data-v-6b0ce1b8><defs data-v-6b0ce1b8><linearGradient id="cardGrad" x1="0%" y1="0%" x2="100%" y2="100%" data-v-6b0ce1b8><stop offset="0%" stop-color="#eff4ff" data-v-6b0ce1b8></stop><stop offset="100%" stop-color="#d9e6ff" data-v-6b0ce1b8></stop></linearGradient></defs><rect x="4" y="6" width="112" height="68" rx="14" fill="url(#cardGrad)" data-v-6b0ce1b8></rect><path d="M22 52h76M30 42h60M40 32h40" stroke="#3a6fe9" stroke-width="3" stroke-linecap="round" data-v-6b0ce1b8></path></svg></div>`,1)),c(`h3`,null,i(e.productName||`未命名商品`),1),c(`p`,P,i(e.shopName||`Shop #${(n=e.shopId)==null?`-`:n}`),1),c(`p`,F,`CNY `+i(typeof e.price==`number`?e.price.toFixed(2):`--`),1)],8,N)}),128))]),h(g,{modelValue:H.value,"onUpdate:modelValue":s[7]||(s[7]=e=>H.value=e),width:`420px`,"align-center":``,"show-close":!1,"close-on-click-modal":!0,class:`login-gate-dialog`,"modal-class":`login-gate-mask`},{header:a(()=>[...s[26]||(s[26]=[c(`div`,{class:`login-gate-title`},`需要登录`,-1)])]),default:a(()=>[c(`p`,I,i(W.value)+` 需要登录后使用。你可以先继续浏览商家和商品，或立即登录。 `,1),c(`div`,L,[h(l,{round:``,onClick:s[6]||(s[6]=e=>H.value=!1)},{default:a(()=>[...s[27]||(s[27]=[m(`继续浏览`,-1)])]),_:1}),h(l,{round:``,type:`primary`,onClick:ye},{default:a(()=>[...s[28]||(s[28]=[m(`去登录`,-1)])]),_:1})])]),_:1},8,[`modelValue`])])}}}),[[`__scopeId`,`data-v-6b0ce1b8`]]);export{R as default};